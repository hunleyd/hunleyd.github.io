<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Automations, timers, and you &middot; Doug's Dabblings
    
  </title>

  
  <link rel="canonical" href="/2021/08/16/Automations-timers-and-you/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Automations, timers, and you</h1>
  <span class="post-date">
    16 Aug 2021,
    This article will take 3 minutes to read.<br />
    smarthome &bullet; computers &bullet; howto <br />
  </span>

  <p>For a while now, I’ve been automating my apartment using the
<a href="https://www.home-assistant.io/docs/automation/basics/">automations</a> component
of <a href="https://www.home-assistant.io">Home Assistant</a>. In fact, I had amassed
quite the collection of automations and was starting to have a problem keeping
track of them all and their various interactions (intentional or otherwise).
So earlier this year when Home Assistant introduced <a href="https://www.home-assistant.io/blog/2021/04/07/release-20214/#automation-debugging">automation
debugging</a>
I decided to sit down and refactor the whole thing.</p>

<p>At first, I considered deploying and using
<a href="https://en.wikipedia.org/wiki/MQTT">MQTT</a> which, it seems, a lot of Home
Assistant users do. However, I wasn’t overly excited at running another
container or at learning Yet Another Thing. Likewise, I considered
<a href="https://community.home-assistant.io/t/home-assistant-community-add-on-node-red/55023">Node-RED</a>
and discarded it too. I’m probably making things harder for myself by sticking
to editing YAML in Vim but I knew my needs weren’t overly complicated and by
sticking to ‘the basics’ I knew it would force me to stop being overly-clever
and make something that Just Works™. So I sat down with the new
debugging tool, wrote out all of my ‘what do i want automated’ needs, and
pored back over the automation documentation.</p>

<p>And that’s when I realized that
a <a href="https://www.home-assistant.io/integrations/timer/">timer</a> was the component
I’d been overlooking all this time. Timers, it turns out, can be used very
much in an MQTT-lite fashion. You see, you can have one or more routines
triggered by the same timer; in fact, some set of routines can listen for
timer (re)start and another set can listen for timer finish/idle. Mix-n-match
these up and you can make some very interesting actions happen. And it means
my automations each generally do one thing and only one thing (KISS) which, in
turn, means they are less likely to fail and easier to debug when they do.
I was stoked! I was also annoyed at not having paid any attention to timers
from the get-go, but what are you gonna do?</p>

<p>My first task was thinking about what timers I’d need. I knew right away I’d want
a <code class="language-plaintext highlighter-rouge">timer.away</code> for when I leave home:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">timer</span><span class="pi">:</span>
  <span class="na">away</span><span class="pi">:</span>
    <span class="na">duration</span><span class="pi">:</span> <span class="s">00:05:00</span>
</code></pre></div></div>

<p>But what other timers do I need? I quickly realized that I need a timer for
almost every switch I have defined in Home Assistant. I could get away with
fewer, but I allowed myself a little bit of cleverness and created one for
each switch <em>with the name of the timer being the name of the switch it
controls</em>. So, for example, I have a TP Link Kasa smart switch controlling my
hallway light called <code class="language-plaintext highlighter-rouge">switch.hallway_light</code>. So I created a matching timer
called <code class="language-plaintext highlighter-rouge">timer.switch_hallway_light</code>. This allows me to to write a simple
automation like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">Trigger - Start light switch trigger</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1625266493'</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">When</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">light</span><span class="nv"> </span><span class="s">turns</span><span class="nv"> </span><span class="s">on,</span><span class="nv"> </span><span class="s">start</span><span class="nv"> </span><span class="s">its</span><span class="nv"> </span><span class="s">corresponding</span><span class="nv"> </span><span class="s">power</span><span class="nv"> </span><span class="s">off</span><span class="nv"> </span><span class="s">trigger'</span>
  <span class="na">trigger</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">switch.bar_light</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">switch.closet_light</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">switch.dining_room_light</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">switch.entryway_light</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">state</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">switch.hallway_light</span>
      <span class="na">to</span><span class="pi">:</span> <span class="s1">'</span><span class="s">on'</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">action</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">timer.start</span>
       <span class="na">data</span><span class="pi">:</span>
         <span class="na">duration</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0:10:00'</span>
       <span class="na">target</span><span class="pi">:</span>
         <span class="na">entity_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">timer.{{</span><span class="nv"> </span><span class="s">trigger.entity_id.split('.')|join('_')</span><span class="nv"> </span><span class="s">}}"</span>
</code></pre></div></div>

<p>What this does is exactly what it says in the description. Whenever one of the
lights in the <code class="language-plaintext highlighter-rouge">trigger</code> section turns on, it starts the corresponding timer.
The magic is in the very last line of the automation:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">entity_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">timer.</span><span class="err">\</span><span class="s">{</span><span class="err">\</span><span class="s">{</span><span class="nv"> </span><span class="s">trigger.entity_id.split('.')|join('_')</span><span class="nv"> </span><span class="err">\</span><span class="s">}</span><span class="err">\</span><span class="s">}"</span>
</code></pre></div></div>

<p>What we’re doing here it taking the entity id that fired the automation (e.g.
what switch did we turn on) from the <code class="language-plaintext highlighter-rouge">trigger.entity_id</code> value then we
swap out the <code class="language-plaintext highlighter-rouge">.</code> for a <code class="language-plaintext highlighter-rouge">_</code> which gives us the name of our timer. So here we
have one automation, that does one very simple thing which makes it kinda hard
to break this automation.</p>

<p>So we’ve turned on the hallway light, and started our timer. What happens when
the timer runs out? Well, we have an automation that is triggered by that:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">alias</span><span class="pi">:</span> <span class="s">Trigger - Kill the lights</span>
  <span class="na">id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1625267293'</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s1">'</span><span class="s">When</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">timer</span><span class="nv"> </span><span class="s">runs</span><span class="nv"> </span><span class="s">out,</span><span class="nv"> </span><span class="s">kill</span><span class="nv"> </span><span class="s">its</span><span class="nv"> </span><span class="s">corresponding</span><span class="nv"> </span><span class="s">light'</span>
  <span class="na">trigger</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">event</span>
      <span class="na">event_type</span><span class="pi">:</span> <span class="s">timer.finished</span>
      <span class="na">event_data</span><span class="pi">:</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">timer.switch_bar_light</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">event</span>
      <span class="na">event_type</span><span class="pi">:</span> <span class="s">timer.finished</span>
      <span class="na">event_data</span><span class="pi">:</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">timer.switch_closet_light</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">event</span>
      <span class="na">event_type</span><span class="pi">:</span> <span class="s">timer.finished</span>
      <span class="na">event_data</span><span class="pi">:</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">timer.switch_dining_room_light</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">event</span>
      <span class="na">event_type</span><span class="pi">:</span> <span class="s">timer.finished</span>
      <span class="na">event_data</span><span class="pi">:</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">timer.switch_entryway_light</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">event</span>
      <span class="na">event_type</span><span class="pi">:</span> <span class="s">timer.finished</span>
      <span class="na">event_data</span><span class="pi">:</span>
        <span class="na">entity_id</span><span class="pi">:</span> <span class="s">timer.switch_hallway_light</span>
  <span class="na">condition</span><span class="pi">:</span> <span class="pi">[]</span>
  <span class="na">action</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">homeassistant.turn_off</span>
    <span class="na">target</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">switch.</span><span class="err">\</span><span class="s">{</span><span class="err">\</span><span class="s">{</span><span class="nv"> </span><span class="s">trigger.event.data.entity_id.split('_')[1:4]|join('_')</span><span class="nv"> </span><span class="err">\</span><span class="s">}</span><span class="err">\</span><span class="s">}"</span>
</code></pre></div></div>

<p>As you can see, it’s basically the opposite of the previous automation. We
list which timers we care about, and when they finish, we munge the timer name
a bit to get the switch’s name and then we turn that switch off. Simplicity.</p>

<p>Hopefully, you can see the utility of timers in Home Assistant. This is just
a very basic example of how I use them, but I think it illustrates their user
pretty well. I still have just over 50 automations, but that’s way down from
what I had, and the automations themselves are now way simpler. Overall,
I consider this a win.</p>

<p>Happy hacking!</p>


  
  <div>
    <h3>Related Posts</h3>
    <ul>
    
      <li><a href="/2021/08/25/I-said-brr-it-s-cold-in-here/">I said brr it's cold in here</a></li>
    
      <li><a href="/2021/08/14/Generating-DNS-noise/">Generating DNS noise</a></li>
    
      <li><a href="/2021/07/26/I-m-blue-da-ba-dee-da-ba-di/">I'm blue da ba dee da ba di</a></li>
    
      <li><a href="/2018/06/18/Locking-it-down/">Locking it down</a></li>
    
      <li><a href="/2016/04/21/PostgresQL-Partitioning-Quick-Tip/">PostgreSQL Partitioning Quick Tip</a></li>
    
    </ul>
  </div>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
