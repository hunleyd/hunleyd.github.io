<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>pgBouncer and auth pass-thru &#8211; Douglas J Hunley</title>
<meta name="description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta name="keywords" content="postgresql">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/db.jpg">

<meta name="twitter:title" content="pgBouncer and auth pass-thru">
<meta name="twitter:description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta name="twitter:creator" content="@hunleyd">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="pgBouncer and auth pass-thru">
<meta property="og:description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta property="og:url" content="/posts/pgBouncer-and-auth-pass-thru/">
<meta property="og:site_name" content="Douglas J Hunley">





<link rel="canonical" href="/posts/pgBouncer-and-auth-pass-thru/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Douglas J Hunley Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<NAV id="dl-menu" class="dl-menuwrapper" role="navigation">
  <BUTTON class="dl-trigger">
    Open Menu
  </BUTTON>
  <UL class="dl-menu">
    <LI>
      <A href="/">Home</A>
    </LI>
    <LI>
      <A href="#">About</A>
      <UL class="dl-submenu">
        <LI>
          <IMG src="/images/avatar.jpg" alt="Douglas J Hunley photo" class="author-photo" />
          <H4>Douglas J Hunley</H4>
          <P>Linux Sys Admin, Gentoo user, PostgreSQL advocate, Android fanboi, OSS supporter, PlayStation gamer</P>
        </LI>
        <LI>
          <A href="/about/"><SPAN class="btn btn-inverse">Learn More</SPAN></A>
        </LI>
        
          <LI>
            <A href="https://dhunley.deviantart.com"><I class="fa fa-deviantart" aria-hidden="true"></I> DeviantArt</A>
          </LI>
        
        
          <LI>
            <A href="mailto:douglas.hunley@gmail.com"><I class="fa fa-envelope" aria-hidden="true"></I> Email</A>
          </LI>
        
        
        
        
          <LI>
            <A href="https://github.com/hunleyd"><I class="fa fa-github" aria-hidden="true"></I> GitHub</A>
          </LI>
        
        
        
          <LI>
            <A href="https://instagram.com/doughunley"><I class="fa fa-instagram" aria-hidden="true"></I> Instagram</A>
          </LI>
        
        
          <LI>
            <A href="https://linkedin.com/in/dhunley"><I class="fa fa-linkedin" aria-hidden="true"></I> LinkedIn</A>
          </LI>
        
        
          <LI>
            <A href="https://meetup.com/members/43608152"><I class="fa fa-meetup" aria-hidden="true"></I> MeetUp</A>
          </LI>
        
        
          <LI>
            <A href="https://reddit.com/u/hunleyd"><I class="fa fa-reddit-alien" aria-hidden="true"></I> Reddit</A>
          </LI>
        
        
        
        
          <LI>
            <A href="https://twitter.com/hunleyd"><I class="fa fa-twitter" aria-hidden="true"></I> Twitter</A>
          </LI>
        
        
          <LI>
            <A href="https://youtube.com/user/doughunley"><I class="fa fa-youtube" aria-hidden="true"></I> YouTube</A>
          </LI>
        
      </UL><!-- /.dl-submenu -->
    </LI>
    <LI>
      <A href="#">Posts</A>
      <UL class="dl-submenu">
        <LI>
          <A href="/posts/">All Posts</A>
        </LI>
        <LI>
          <A href="/tags/">All Tags</A>
        </LI>
      </UL>
    </LI>
    
  </UL><!-- /.dl-menu -->
</NAV><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/db.jpg" alt="pgBouncer and auth pass-thru">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/posts/pgBouncer-and-auth-pass-thru/" rel="bookmark" title="pgBouncer and auth pass-thru">pgBouncer and auth pass-thru</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2018-08-07T08:53:28-04:00">August 07, 2018</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~6 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>I’ve noticed several individuals inquiring lately about pgBouncer and how they can avoid putting all users and their passwords in it’s <code class="language-plaintext highlighter-rouge">auth_file</code>. After the most recent such inquiry (hi Richard!) I decided I’d write this post to
hopefully make it clearer how to use ‘pass-thru auth’ and avoid maintaining your users and their passwords in an external file. So let’s see what this takes, shall we?</p>

<p>First, install pgBouncer as per your OS (<code class="language-plaintext highlighter-rouge">yum</code>, <code class="language-plaintext highlighter-rouge">apt</code>, <code class="language-plaintext highlighter-rouge">brew</code>, etc):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; brew install pgbouncer
Updating Homebrew...
==&gt; Auto-updated Homebrew!
Updated 1 tap (homebrew/core).
==&gt; Updated Formulae
&lt;snip&gt;
==&gt; Downloading https://homebrew.bintray.com/bottles/pgbouncer-1.8.1.high_sierra
######################################################################## 100.0%
==&gt; Pouring pgbouncer-1.8.1.high_sierra.bottle.tar.gz
==&gt; Caveats
The config file: /usr/local/etc/pgbouncer.ini is in the "ini" format and you
will need to edit it for your particular setup. See:
https://pgbouncer.github.io/config.html

The auth_file option should point to the /usr/local/etc/userlist.txt file which
can be populated by the /usr/local/opt/pgbouncer/bin/mkauth.py script.

To have launchd start pgbouncer now and restart at login:
  brew services start pgbouncer
Or, if you do not want/need a background service you can just run:
  pgbouncer -q /usr/local/etc/pgbouncer.ini
==&gt; Summary
🍺  /usr/local/Cellar/pgbouncer/1.8.1: 17 files, 399.9KB
</code></pre></div></div>

<p>Great, so now we have pgBouncer installed.</p>

<p>To make life easier on ourselves, we’re going to <strong>temporarily</strong> enable trusted local socket connections in our <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all trust
</code></pre></div></div>

<p>Right now, this is the only line in my <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>. Let’s SIGHUP the postmaster so it takes affect:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; pg_ctl <span class="nt">-D</span> <span class="nv">$PGDATA</span> reload
server signaled
</code></pre></div></div>

<p>And test it:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">unset </span>PGPASSWORD <span class="p">;</span> psql <span class="nt">-U</span> doug <span class="nt">-d</span> doug <span class="nt">-c</span> <span class="s2">"select now();"</span>
┌───────────────────────────────┐
│              now              │
├───────────────────────────────┤
│ 2018-08-07 13:19:06.343245-04 │
└───────────────────────────────┘
<span class="o">(</span>1 row<span class="o">)</span>

Time: 1.959 ms
</code></pre></div></div>

<p>OK, we can connect without issue.</p>

<p>Let’s configure pgBouncer now. As per the output above, I need to edit <code class="language-plaintext highlighter-rouge">/usr/local/etc/pgbouncer.ini</code> but yours is probably in plain old <code class="language-plaintext highlighter-rouge">/etc</code>:</p>

<div class="language-config highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">databases</span>]

; <span class="n">any</span> <span class="n">db</span> <span class="n">over</span> <span class="n">Unix</span> <span class="n">socket</span>
* =

[<span class="n">pgbouncer</span>]

<span class="n">logfile</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">pgbouncer</span>.<span class="n">log</span>
<span class="n">pidfile</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">pgbouncer</span>.<span class="n">pid</span>

; <span class="n">IP</span> <span class="n">address</span> <span class="n">or</span> * <span class="n">which</span> <span class="n">means</span> <span class="n">all</span> <span class="n">IPs</span>
<span class="n">listen_addr</span> = <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>
<span class="n">listen_port</span> = <span class="m">6432</span>

<span class="n">unix_socket_dir</span> = /<span class="n">tmp</span>

; <span class="n">any</span>, <span class="n">trust</span>, <span class="n">plain</span>, <span class="n">crypt</span>, <span class="n">md5</span>, <span class="n">cert</span>, <span class="n">hba</span>, <span class="n">pam</span>
<span class="n">auth_type</span> = <span class="n">trust</span>
<span class="n">auth_file</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">userlist</span>.<span class="n">txt</span>

<span class="n">admin_users</span> = <span class="n">doug</span>

<span class="n">stats_users</span> = <span class="n">doug</span>

<span class="n">pool_mode</span> = <span class="n">transaction</span>

<span class="n">server_reset_query</span> = <span class="n">DISCARD</span> <span class="n">ALL</span>


<span class="n">max_client_conn</span> = <span class="m">100</span>

<span class="n">default_pool_size</span> = <span class="m">20</span>
</code></pre></div></div>

<p>As you can see, we’re gonna pass connections to any db back to the postmaster via a local socket. I put the logs in my <code class="language-plaintext highlighter-rouge">$HOME</code> for ease of use. I put the <code class="language-plaintext highlighter-rouge">auth_file</code> in my <code class="language-plaintext highlighter-rouge">$HOME</code> as well. Then I set myself up as both an admin and stats
user. I changed the mode into <strong>transaction</strong> which is <em>usually</em> the mode you want. Now, I add myself to the auth_file:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">echo</span> <span class="s1">'"doug" "md5540094bd8172cd963fdfa773fe44b488"'</span> <span class="o">&gt;</span> userlist.txt
</code></pre></div></div>

<p>(NOTE: I did a select on pg_shadow as a SUPERUSER to get these values.)</p>

<p>And start pgBouncer:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; pgbouncer /usr/local/etc/pgbouncer.ini
2018-08-07 13:43:46.453 92057 LOG File descriptor limit: 7168 <span class="o">(</span>H:-1<span class="o">)</span>, max_client_conn: 90, max fds possible: 100
2018-08-07 13:43:46.455 92057 LOG listening on 127.0.0.1:6432
2018-08-07 13:43:46.455 92057 LOG listening on unix:/tmp/.s.PGSQL.6432
2018-08-07 13:43:46.455 92057 LOG process up: pgbouncer 1.8.1, libevent 2.1.8-stable <span class="o">(</span>kqueue<span class="o">)</span>, adns: evdns2, tls: OpenSSL 1.0.2o  27 Mar 2018
</code></pre></div></div>

<p>Now, we see if we can connect to pgBouncer’s internal db:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-X</span>
psql <span class="o">(</span>10.4, server 1.8.1/bouncer<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">pgbouncer</span><span class="o">=</span><span class="c"># show pools;</span>
 database  |   user    | cl_active | cl_waiting | sv_active | sv_idle | sv_used | sv_tested | sv_login | maxwait | maxwait_us | pool_mode
<span class="nt">-----------</span>+-----------+-----------+------------+-----------+---------+---------+-----------+----------+---------+------------+-----------
 pgbouncer | pgbouncer |         1 |          0 |         0 |       0 |       0 |         0 |        0 |       0 |          0 | statement
<span class="o">(</span>1 row<span class="o">)</span>
</code></pre></div></div>

<p>Success!</p>

<p>Now, can we connect to one of our PostgreSQL dbs through pgBouncer:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> doug
psql <span class="o">(</span>10.4<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="o">(</span>doug@127.0.0.1:6432/doug[92825]<span class="o">)</span> <span class="c">#</span>
</code></pre></div></div>

<p>Huzzah!</p>

<p>We will now alter <code class="language-plaintext highlighter-rouge">pgbouncer.ini</code> and set <code class="language-plaintext highlighter-rouge">auth_type = md5</code> and edit <code class="language-plaintext highlighter-rouge">pg_hba.conf</code> to use md5 as well to make sure we’re not passing around plaintext passwords. Our retest looks like:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">grep</span> ^local <span class="nv">$PGDATA</span>/pg_hba.conf
<span class="nb">local   </span>all             all md5

doug@ReturnOfTheMac ~&gt; pg_ctl <span class="nt">-D</span> <span class="nv">$PGDATA</span> reload
server signaled
doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> doug
Password:
psql <span class="o">(</span>10.4<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="o">(</span>doug@127.0.0.1:6432/doug[97966]<span class="o">)</span> <span class="c"># \q</span>
doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-X</span>
Password:
psql <span class="o">(</span>10.4, server 1.8.1/bouncer<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">pgbouncer</span><span class="o">=</span><span class="c"># \q</span>
</code></pre></div></div>

<p>Which, as you can see, we were now password prompted both times!</p>

<p>Now, that we know it all works, we can go about changing things to not expose users through
the <code class="language-plaintext highlighter-rouge">auth_file</code>. First, we’ll create a <code class="language-plaintext highlighter-rouge">pgbouncer</code> user on our db, then we will
create a SECURITY DEFINER function will allow the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user to
(essentially) ‘sudo’ as a superuser to look at the <code class="language-plaintext highlighter-rouge">pg_shadow</code> table, and finally
we will ensure only our <code class="language-plaintext highlighter-rouge">pgbouncer</code> user can execute that function:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">pgbouncer</span> <span class="k">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s1">'secret'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">ROLE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">4</span><span class="p">.</span><span class="mi">102</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">GRANT</span> <span class="k">CONNECT</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">doug</span> <span class="k">TO</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">GRANT</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">13</span><span class="p">.</span><span class="mi">531</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">pgbouncer</span> <span class="n">LOGIN</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">ROLE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">6</span><span class="p">.</span><span class="mi">457</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="k">in</span> <span class="n">i_username</span> <span class="nb">text</span><span class="p">,</span> <span class="k">out</span> <span class="n">uname</span> <span class="nb">text</span><span class="p">,</span> <span class="k">out</span> <span class="n">phash</span> <span class="nb">text</span><span class="p">)</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="k">RETURNS</span> <span class="n">record</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">SELECT</span> <span class="n">usename</span><span class="p">,</span> <span class="n">passwd</span> <span class="k">FROM</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_shadow</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">WHERE</span> <span class="n">usename</span> <span class="o">=</span> <span class="n">i_username</span> <span class="k">INTO</span> <span class="n">uname</span><span class="p">,</span> <span class="n">phash</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">RETURN</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="k">END</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span> <span class="k">SECURITY</span> <span class="k">DEFINER</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">21</span><span class="p">.</span><span class="mi">219</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">REVOKE</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> <span class="k">FROM</span> <span class="k">public</span><span class="p">,</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">REVOKE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">330</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">GRANT</span> <span class="k">EXECUTE</span> <span class="k">ON</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> <span class="k">TO</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">GRANT</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">572</span> <span class="n">ms</span>
</code></pre></div></div>

<p>(NOTE: Astute readers will note I’m connected as ‘doug’ to the db. This works cause in my setup that is a SUPERUSER. You should probably use the ‘postgres’ account.)</p>

<p>And, let’s tell PgBouncer to use this function:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">grep</span> ^auth /usr/local/etc/pgbouncer.ini
auth_type <span class="o">=</span> md5
auth_file <span class="o">=</span> /Users/doug/userlist.txt
auth_user <span class="o">=</span> pgbouncer
auth_query <span class="o">=</span> SELECT <span class="k">*</span> FROM public.user_lookup<span class="o">(</span><span class="nv">$1</span><span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>And let’s edit our <code class="language-plaintext highlighter-rouge">auth_file</code> to only contain the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user’s info:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">cat </span>userlist.txt
<span class="s2">"pgbouncer"</span> <span class="s2">"md509d12ff67352814e4c467c7f55a3a1d7"</span>
doug@ReturnOfTheMac ~&gt;
</code></pre></div></div>

<p>Restart pgBouncer, and let’s recheck:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">doug</span><span class="o">@</span><span class="n">ReturnOfTheMac</span> <span class="o">~&gt;</span> <span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="o">-</span><span class="n">p</span> <span class="mi">6432</span> <span class="o">-</span><span class="n">d</span> <span class="n">doug</span>                      <span class="mi">2</span>
<span class="n">Password</span><span class="p">:</span>
<span class="n">psql</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">7076</span><span class="p">])</span> <span class="o">#</span> <span class="k">select</span> <span class="n">now</span><span class="p">();</span>
<span class="err">┌───────────────────────────────┐</span>
<span class="err">│</span>              <span class="n">now</span>              <span class="err">│</span>
<span class="err">├───────────────────────────────┤</span>
<span class="err">│</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span> <span class="mi">14</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">45</span><span class="p">.</span><span class="mi">938919</span><span class="o">-</span><span class="mi">04</span> <span class="err">│</span>
<span class="err">└───────────────────────────────┘</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>

<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">438</span> <span class="n">ms</span>
</code></pre></div></div>

<p>It works! But what about the pgBouncer internal db?</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer
psql: ERROR:  No such user: doug
</code></pre></div></div>

<p>Well, that makes sense. The <code class="language-plaintext highlighter-rouge">auth_file</code> only has a <code class="language-plaintext highlighter-rouge">pgbouncer</code> user. So, let’s edit the <code class="language-plaintext highlighter-rouge">pgbouncer.ini</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">grep</span> <span class="s1">'_users'</span> /usr/local/etc/pgbouncer.ini
admin_users <span class="o">=</span> pgbouncer
stats_users <span class="o">=</span> pgbouncer
</code></pre></div></div>

<p>Retart pgBouncer once more and check:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-U</span> pgbouncer <span class="nt">-X</span>
Password <span class="k">for </span>user pgbouncer:
psql <span class="o">(</span>10.4, server 1.8.1/bouncer<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="nv">pgbouncer</span><span class="o">=</span><span class="c"># show clients;</span>
 <span class="nb">type</span> |   user    | database  | state  |   addr    | port  | local_addr | local_port |    connect_time     |    request_time     | <span class="nb">wait</span> | wait_us |      ptr       | <span class="nb">link</span> | remote_pid | tls
<span class="nt">------</span>+-----------+-----------+--------+-----------+-------+------------+------------+---------------------+---------------------+------+---------+----------------+------+------------+-----
 C    | pgbouncer | pgbouncer | active | 127.0.0.1 | 54191 | 127.0.0.1  |       6432 | 2018-08-07 14:48:03 | 2018-08-07 14:48:06 |    0 |       0 | 0x7fa082005010 |      |          0 |
<span class="o">(</span>1 row<span class="o">)</span>
</code></pre></div></div>

<p>And we’re golden!</p>

<p>You can connect to pgBouncer internally using the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user, and you can connect to our normal PostgreSQL db as any valid user and it uses our function to do the auth!</p>

<p>To complete this setup, we’re gonna move PostgreSQL to port <code class="language-plaintext highlighter-rouge">5433</code> and pgBouncer to port <code class="language-plaintext highlighter-rouge">5432</code>:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">grep </span>port /usr/local/etc/pgbouncer.ini
listen_port <span class="o">=</span> 5432
doug@ReturnOfTheMac ~&gt; <span class="nb">grep </span>port <span class="nv">$PGDATA</span>/postgresql.conf
port <span class="o">=</span> 5433				<span class="c"># (change requires restart)</span>
</code></pre></div></div>

<p>So now, if someone tries to connect to our PostgreSQL on the default TCP/IP port, it goes through PgBouncer transparently (and then pgBouncer connects locally via a socket). Our users/apps are none the wiser, and us DBAs can always <code class="language-plaintext highlighter-rouge">ssh</code> into the box and connect directly to PostgreSQL via socket if needed. And we’re not exposing any user/app passwords in a text file on the OS.</p>

<p>WIN WIN</p>

<p>One final note: this is only working for the ‘doug’ database currently. If I wanted this to also work for another database, say ‘postgres’ or ‘prod_app’ then I would need to GRANT CONNECT on those dbs to ‘pgbouncer’ <strong>and</strong> would need to create my function in them as well.</p>

<p>☮️</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#postgresql" title="Pages tagged postgresql" class="tag"><span class="term">postgresql</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/posts/pgBouncer-and-auth-pass-thru/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/posts/pgBouncer-and-auth-pass-thru/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/posts/pgBouncer-and-auth-pass-thru/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/posts/Locking-it-down/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/posts/tuned-PG-and-you/" title="tuned, PG, and you">tuned, PG, and you</a></h3>
      <p>We've had a small flurry of customers asking about tuning their OS for the best PostgreSQL performance. While the answer to this question...&hellip; <a href="/posts/tuned-PG-and-you/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/posts/The-continuing-adventures-of-Mom-cutting-the-cord/" title="The continuing adventures of Mom cutting the cord">The continuing adventures of Mom cutting the cord</a></h4>
        <span>Published on February 07, 2019</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/posts/pgBackRest-2.08-and-macOS-Mojave/" title="pgBackRest 2.08 and macOS Mojave">pgBackRest 2.08 and macOS Mojave</a></h4>
        <span>Published on January 04, 2019</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2020 Douglas J Hunley.<BR /><FONT size=-1>Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a>. Served via <a href="https://github.com">GitHub</a>. Themed using <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR</a>.</FONT></span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'douglashunley'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
