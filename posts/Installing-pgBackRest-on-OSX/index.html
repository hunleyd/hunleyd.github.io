<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Installing pgBackRest on OSX &#8211; Douglas J Hunley</title>
<meta name="description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta name="keywords" content="postgresql, osx">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/db.jpg">

<meta name="twitter:title" content="Installing pgBackRest on OSX">
<meta name="twitter:description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta name="twitter:creator" content="@hunleyd">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Installing pgBackRest on OSX">
<meta property="og:description" content="It's not that I'm anti-social; I'm just not user-friendly">
<meta property="og:url" content="/posts/Installing-pgBackRest-on-OSX/">
<meta property="og:site_name" content="Douglas J Hunley">





<link rel="canonical" href="/posts/Installing-pgBackRest-on-OSX/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Douglas J Hunley Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<NAV id="dl-menu" class="dl-menuwrapper" role="navigation">
  <BUTTON class="dl-trigger">
    Open Menu
  </BUTTON>
  <UL class="dl-menu">
    <LI>
      <A href="/">Home</A>
    </LI>
    <LI>
      <A href="#">About</A>
      <UL class="dl-submenu">
        <LI>
          <IMG src="/images/avatar.jpg" alt="Douglas J Hunley photo" class="author-photo" />
          <H4>Douglas J Hunley</H4>
          <P>Linux Sys Admin, Gentoo user, PostgreSQL advocate, Android fanboi, OSS supporter, PlayStation gamer</P>
        </LI>
        <LI>
          <A href="/about/"><SPAN class="btn btn-inverse">Learn More</SPAN></A>
        </LI>
        
          <LI>
            <A href="https://dhunley.deviantart.com"><I class="fa fa-deviantart" aria-hidden="true"></I> DeviantArt</A>
          </LI>
        
        
          <LI>
            <A href="mailto:douglas.hunley@gmail.com"><I class="fa fa-envelope" aria-hidden="true"></I> Email</A>
          </LI>
        
        
        
        
          <LI>
            <A href="https://github.com/hunleyd"><I class="fa fa-github" aria-hidden="true"></I> GitHub</A>
          </LI>
        
        
        
          <LI>
            <A href="https://instagram.com/doughunley"><I class="fa fa-instagram" aria-hidden="true"></I> Instagram</A>
          </LI>
        
        
          <LI>
            <A href="https://linkedin.com/in/dhunley"><I class="fa fa-linkedin" aria-hidden="true"></I> LinkedIn</A>
          </LI>
        
        
          <LI>
            <A href="https://meetup.com/members/43608152"><I class="fa fa-meetup" aria-hidden="true"></I> MeetUp</A>
          </LI>
        
        
          <LI>
            <A href="https://reddit.com/u/hunleyd"><I class="fa fa-reddit-alien" aria-hidden="true"></I> Reddit</A>
          </LI>
        
        
        
        
          <LI>
            <A href="https://twitter.com/hunleyd"><I class="fa fa-twitter" aria-hidden="true"></I> Twitter</A>
          </LI>
        
        
          <LI>
            <A href="https://youtube.com/user/doughunley"><I class="fa fa-youtube" aria-hidden="true"></I> YouTube</A>
          </LI>
        
      </UL><!-- /.dl-submenu -->
    </LI>
    <LI>
      <A href="#">Posts</A>
      <UL class="dl-submenu">
        <LI>
          <A href="/posts/">All Posts</A>
        </LI>
        <LI>
          <A href="/tags/">All Tags</A>
        </LI>
      </UL>
    </LI>
    
  </UL><!-- /.dl-menu -->
</NAV><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
  <div class="entry-image">
    <img src="/images/db.jpg" alt="Installing pgBackRest on OSX">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/posts/Installing-pgBackRest-on-OSX/" rel="bookmark" title="Installing pgBackRest on OSX">Installing pgBackRest on OSX</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2017-06-14T08:40:30-04:00">June 14, 2017</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
Reading time ~3 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>If you’ve followed my previous posts (<a href="https://hunleyd.github.io/posts/PostgreSQL-Homebrew-and-You/">here</a> and <a href="https://hunleyd.github.io/posts/Getting-fancy-with-PostgreSQL-and-Homebrew/">here</a>), then you already have one or more versions of PostgreSQL installed on your Mac. Maybe these are solely for test or dev purposes and you don’t really care about any of the data therein, but if you do, let me guide you to <a href="http://www.pgbackrest.org/">pgBackRest</a>.</p>

<blockquote>
  <p>pgBackRest aims to be a simple, reliable backup and restore system that can seamlessly scale up to the largest databases and workloads.</p>
</blockquote>

<blockquote>
  <p>Instead of relying on traditional backup tools like tar and rsync, pgBackRest implements all backup features internally and uses a custom protocol for communicating with remote systems. Removing reliance on tar and rsync allows for better solutions to database-specific backup challenges. The custom remote protocol allows for more flexibility and limits the types of connections that are required to perform a backup which increases security.</p>
</blockquote>

<p>pgBackRest is written in Perl, but don’t hold that against it. As of the 1.19 release, pgBackRest can now use S3 buckets as the storage backend. I <em>really</em> like pgBackRest and tend to use it for myself and customers over any of the other tools in the PostgreSQL ecosphere. So, let’s get started by downloading the latest release from their site, and then installing it. For some reason, no one has added pgBackRest to Homebrew yet (someone, pls!) so let’s do it the manual way:</p>

<script src="https://gist.github.com/hunleyd/4e7390cc161206d1e53019c8e44a20b7.js"> </script>

<p>(Keep in mind that I already had Perl setup to connect to PostgreSQL for other uses. You might need to install <code class="highlighter-rouge">DBD::Pg</code>.)</p>

<p>Now that pgBackRest is installed, let’s configure it. First, we’ll want to set some of the global properties that affect all pgBackRest operations:</p>

<script src="https://gist.github.com/hunleyd/005748ef36074b225619f79ab3420c54.js"> </script>

<p>As you can see, we set the following:</p>

<ul>
  <li>force the log level for all console output to ‘info’</li>
  <li>define the S3 bucket we want to use</li>
  <li>define the S3 endpoint to connect to</li>
  <li>define our S3 key</li>
  <li>define our S3 secret key</li>
  <li>set which region our bucket is in</li>
  <li>tell pgBackRest that we’re using S3 as the backend</li>
  <li>configure retention of full backups</li>
  <li>tell pgBackRest to issue a CHECKPOINT so backups can start right away instead of waiting for the next regular checkpoint</li>
</ul>

<p>Now, we need to tell pgBackRest which instance of PostgreSQL we want to backup and where to find it. Again, if you used my previous posts to install multiple versions via Homebrew, this should look familiar:</p>

<script src="https://gist.github.com/hunleyd/fea13b1e4b57f7c0ad068ef2579a04cd.js"> </script>

<p>You can see for each pg cluster, we define:</p>

<ul>
  <li>the path to the <code class="highlighter-rouge">$PGDATA</code> directory</li>
  <li>the port the cluster listens on</li>
  <li>and the path we want to store the backups in on our backend</li>
</ul>

<p>When you put this all together, we’ll be connecting to an S3 bucket called, creatively enough, <code class="highlighter-rouge">hunleyd-pgbackrest</code> and then we will create a top-level directory (‘96’, ‘95’, etc) to store each cluster’s backups in.</p>

<p>Now that we’ve got our configuration complete, let’s do an initial backup of one of the clusters. First, we have to create the appropriate directories and metadata on the backend:</p>

<script src="https://gist.github.com/hunleyd/ac4aa555e10ffa9a210983d7997e3ebc.js"> </script>

<p>Then, we have pgBackRest verify that everything is properly setup. Note that this includes checking to ensure you tweaked <code class="highlighter-rouge">postgresql.conf</code> according to the directions on their site (I’m not going to repeat them here):</p>

<script src="https://gist.github.com/hunleyd/56358e6024a84833af73fda3d7d71432.js"> </script>

<p>And since that all worked, we can take our first actual backup:</p>

<script src="https://gist.github.com/hunleyd/fdc5991f31aa098f685a3a462461d897.js"> </script>

<p>Neat!</p>

<p>Now, let’s check our S3 bucket, shall we?</p>

<p><img src="/images/posts/s3_1.png" alt="s3_1" /></p>

<p>You can see here the top-level contents of my <code class="highlighter-rouge">hunleyd-pgbackrest</code> bucket. As stated before, each cluster gets its own sub-dir. Since we just backed up the ‘92’ cluster, let’s look inside it’s dir.</p>

<p><img src="/images/posts/s3_2.png" alt="s3_2" /></p>

<p>You can see that pgBackRest has created as directory for the WALs to be stored in whenever <code class="highlighter-rouge">archive_command</code> fires and another directory for the actual cluster backups. Peeking into the <code class="highlighter-rouge">archive</code> dir, we see:</p>

<p><img src="/images/posts/s3_3.png" alt="s3_3" /></p>

<p>This shows us some metadata, and shows that pgBackRest creates a directory for each timeline of the cluster. Since we are on timeline 1 in our 92 cluster, we have a <code class="highlighter-rouge">9.2-1</code> directory inside of which, we find:</p>

<p><img src="/images/posts/s3_4.png" alt="s3_4" /></p>

<p>Our archived WALs have been compressed and uploaded. Hurray!</p>

<p>Now, let’s check inside the <code class="highlighter-rouge">backup</code> directory:</p>

<p><img src="/images/posts/s3_5.png" alt="s3_5" /></p>

<p>We can see some metadata, and we can see a folder named the same as the backup label that was used when we ran our full backup. Inside that folder, we can see:</p>

<p><img src="/images/posts/s3_6.png" alt="s3_6" /></p>

<p>Hey look, more metadata! And another folder! :) So, let’s dive into the <code class="highlighter-rouge">pg_data</code> folder where we see:</p>

<p><img src="/images/posts/s3_7.png" alt="s3_7" /></p>

<p>Holy crap! It’s a basebackup of our <code class="highlighter-rouge">$PGDATA</code> data directory. And all the files have been nicely compressed for us. Rock on, pgBackRest!</p>

<p>And just in case you wanted to see the current backup catalog:</p>

<script src="https://gist.github.com/hunleyd/f553b0931a571965ca9bcb6235cb8fcf.js"> </script>

<p>(look at that compression!)</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#postgresql" title="Pages tagged postgresql" class="tag"><span class="term">postgresql</span></a><a href="/tags/#osx" title="Pages tagged osx" class="tag"><span class="term">osx</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/posts/Installing-pgBackRest-on-OSX/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/posts/Installing-pgBackRest-on-OSX/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/posts/Installing-pgBackRest-on-OSX/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/posts/Goodbye-Loui-boy/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/posts/The-continuing-adventures-of-Mom-cutting-the-cord/" title="The continuing adventures of Mom cutting the cord">The continuing adventures of Mom cutting the cord</a></h3>
      <p>As a belated update to this post, Mom has told DirecTV to completely go screw and she’s moved over to Philo where she’s currently loving ...&hellip; <a href="/posts/The-continuing-adventures-of-Mom-cutting-the-cord/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/posts/pgBackRest-2.07-and-macOS-Mojave/" title="pgBackRest 2.07 and macOS Mojave">pgBackRest 2.07 and macOS Mojave</a></h4>
        <span>Published on November 16, 2018</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/posts/Monitoring-pgBackRest-with-tail_n_mail/" title="Monitoring pgBackRest with tail_n_mail">Monitoring pgBackRest with tail_n_mail</a></h4>
        <span>Published on September 24, 2018</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2019 Douglas J Hunley.<BR /><FONT size=-1>Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a>. Served via <a href="https://github.com">GitHub</a>. Themed using <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR</a>.</FONT></span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'douglashunley'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
