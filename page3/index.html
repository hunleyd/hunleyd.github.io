<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Doug's Dabblings &middot; Quick thoughts on stuff I'm playing with
    
  </title>

  
  <link rel="canonical" href="/page3/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2021/08/14/Generating-DNS-noise/">
        Generating DNS noise
      </a>
    </h1>

    <span class="post-date">14 Aug 2021</span>

    <p><a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS</a> is one of those thing
most people never think about. It’s one of those things in the background that
quietly does its job and no one pays it no mind. Which is why it’s surprising
to people when they discover that if their DNS traffic can be logged, a very
informative picture of them can be created.</p>

<p>To combat this user fingerprinting/tracking, enhancements to DNS like <a href="https://en.wikipedia.org/wiki/DNS_over_HTTPS">DNS over
HTTPS</a> and <a href="https://en.wikipedia.org/wiki/DNS_over_TLS">DNS over
TLS</a> come into existence. And
while I’m not knocking those solutions, I would like to point out that the
endpoint <em>still knows what lookups you performed</em>. Unfortunately, there isn’t
really any way currently to ask a server ‘hey, whats the IP address for
google.com’’ and not have the other end know that you asked for Google’s
website. It’s literally the nature of the task for the other end to know all
the websites you asked for name resolution of.</p>

<p>So what can a person do to make it harder for the other end to create a useful
picture of your surfing habits? Well, data is only as useful as it is clean.
If you have a list of 1000 DNS requests from the user, then you can be fairly
certain where that user was surfing (more technically, where the source IP was
surfing, but let’s not get pedantic). However, if you had a list of 1000000 DNS
requests, of which 1000 were the original legitimate DNS requests, and the
remaining 999000 were randomly generated by a process, then how easily could
you determine where the user was actually surfing? Essentially, you’ve reduced
the Signal-to-Noise so low that the signal is ‘lost’.</p>

<p>With this goal in mind, I set out to introduce some noise into my DNS requests
as my weekend project this weekend. It turned out to be easier than I expected
thanks to some existing work by others (always stand on other’s shoulders when
you can). The first thing I did was clone down a copy of
<a href="https://github.com/1tayH/noisy">noisy</a>. After playing with it a bit, I felt
like it was a decent base, but I didn’t care for the default “root_urls” (The
Pirate Bay? Really? I don’t need my ISP sending me cease-and-desist letters,
thank you), I didn’t think there were enough “root_urls”, and I didn’t like
that the “root_urls” were never updated. Thankfully, Cisco has a project
called <a href="https://umbrella.cisco.com/blog/cisco-umbrella-1-million">Umbrella</a>
that seems like a good fit for all three concerns.</p>

<p>At this point, it was just a matter of gluing all these pieces together.
A <code class="language-plaintext highlighter-rouge">sudo</code> later, and it was time to start working. The first thing I did was
create <code class="language-plaintext highlighter-rouge">/etc/noisy</code> to hold my modified config and to provide a working
directory for the daemon. Daemon, you say? Yup, for the second step, we create
a systemd service file to run our <code class="language-plaintext highlighter-rouge">noise</code> process. The
<code class="language-plaintext highlighter-rouge">/etc/systemd/system/noisy.service</code> file ends up looking like:</p>

<div class="language-systemd highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">[Unit]</span>
<span class="nt">Description</span><span class="p">=</span>Simple random DNS, HTTP/S internet traffic noise generator

<span class="k">[Service]</span>
<span class="nt">WorkingDirectory</span><span class="p">=</span>/etc/noisy
<span class="nt">ExecStart</span><span class="p">=</span>/usr/bin/python /srv/repos/noisy/noisy.py --config /etc/noisy/config.json
<span class="nt">SyslogIdentifier</span><span class="p">=</span>noisy

<span class="k">[Install]</span>
<span class="nt">WantedBy</span><span class="p">=</span>multi-user.target
</code></pre></div></div>

<p>With this incredibly simple setup in place, systemd will launch the Python
script in our copy of the repo (<code class="language-plaintext highlighter-rouge">/srv/repos/noisy</code> on my system), use the
config file I write in <code class="language-plaintext highlighter-rouge">/etc/noisy</code>, and will log to <code class="language-plaintext highlighter-rouge">journald</code> while
identifying itself as <code class="language-plaintext highlighter-rouge">noisy</code> in the journal.</p>

<p>Now we just need to write our config file to use the hosts from Umbrella.
Thankfully, <code class="language-plaintext highlighter-rouge">noisy</code> uses JSON for its config file, so rewriting it is trivial.
I created a Bash script to handle this for me:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">mv</span> /etc/noisy/top-1m.csv.zip /etc/noisy/top-1m.csv.zip.old

wget <span class="nt">-q</span> <span class="nt">-O</span> /etc/noisy/top-1m.csv.zip http://s3-us-west-1.amazonaws.com/umbrella-static/top-1m.csv.zip

unzip <span class="nt">-q</span> <span class="nt">-d</span> /etc/noisy <span class="nt">-o</span> /etc/noisy/top-1m.csv.zip

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/noisy/config.json
{
        "max_depth": 25,
        "min_sleep": 3,
        "max_sleep": 6,
        "timeout": false,
        "root_urls": [
</span><span class="no">EOF

</span><span class="nb">cat</span> /etc/noisy/top-1m.csv | <span class="nb">cut</span> <span class="nt">-d</span>, <span class="nt">-f2</span> | <span class="k">while </span><span class="nb">read </span>url<span class="p">;</span> <span class="k">do
        </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t\t\"</span><span class="s2">http://</span><span class="k">${</span><span class="nv">url</span><span class="k">}</span><span class="se">\"</span><span class="s2">,"</span> <span class="o">&gt;&gt;</span> /etc/noisy/config.json
<span class="k">done

</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t\t\"</span><span class="s2">https://medium.com</span><span class="se">\"</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> /etc/noisy/config.json

<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/noisy/config.json
        ],
        "blacklisted_urls": [
                "https://t.co",
                "t.umblr.com",
                "messenger.com",
                "itunes.apple.com",
                "l.facebook.com",
                "bit.ly",
                "mediawiki",
                ".css",
                ".ico",
                ".xml",
                "intent/tweet",
                "twitter.com/share",
                "dialog/feed?",
                ".json",
                "zendesk",
                "clickserve",
                ".png",
                ".iso"
        ],
        "user_agents": [
</span><span class="no">EOF

</span><span class="nb">cat</span> /srv/repos/noisy/config.json|jq .user_agents | <span class="nb">tail</span> <span class="nt">-n</span> +2 <span class="o">&gt;&gt;</span> /etc/noisy/config.json

<span class="nb">echo</span> <span class="s1">'}'</span> <span class="o">&gt;&gt;</span> /etc/noisy/config.json

<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/^M//'</span> /etc/noisy/config.json

systemctl restart noisy
</code></pre></div></div>

<p>This script moves the previously downloaded Umbrella file out of the way,
downloads the latest version from S3, and unzips it. This gives us a CSV file
that we’ll use in a moment. The script then starts writing the config file by
setting some defaults and starting the ‘root_urls’ key. We then look over
every line in the CSV file, and pull the URL from the 2<sup>nd</sup> field. We
prepend ‘http://’ to the URL and write the result out to our config file. To
close out the ‘root_urls’ section, we write <a href="https://medium.com">medium.com</a>
to it (just to always have a known quantity as the ‘end marker’ if I need to
debug anything). Up next, we copy over the ‘blacklisted_urls’ keys from the
default config, and finally we use <code class="language-plaintext highlighter-rouge">jq</code> to pull all the ‘user_agents’ into our
config. Because Cisco uses DOS line-endings, we run a <code class="language-plaintext highlighter-rouge">sed</code> on the resulting
file to remove these and we’re good to go. I’m sure there’s a “better” way to do
all this, but it wasn’t worth optimizing for now, imho.</p>

<p>Now that we’ve got our file in shape, we tell <code class="language-plaintext highlighter-rouge">systemd</code> to restart the daemon
and we’re off to the races, as <code class="language-plaintext highlighter-rouge">journalctl</code> shows:</p>

<pre><code class="language-log">Aug 14 17:09:02 nuc noisy[240416]: INFO:root:Visiting https://www.potpourrigift.com
Aug 14 17:09:07 nuc noisy[240416]: INFO:root:Visiting https://www.potpourrigift.com/ShopCategory.aspx?ID=320,362&amp;ITEMS=RE9032%7CR0D067%7CR82102%7CRD9008&amp;HPLoc=MB18
Aug 14 17:09:13 nuc noisy[240416]: INFO:root:Visiting
https://www.potpourrigift.com/CustomerService.aspx?page=Free+Catalog
</code></pre>

<p>And now I’m sure my ISP hates me ;)</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page4">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page2">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
