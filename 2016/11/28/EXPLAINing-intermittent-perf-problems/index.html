<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      EXPLAINing intermittent perf problems &middot; Doug's Dabblings
    
  </title>

  
  <link rel="canonical" href="/2016/11/28/EXPLAINing-intermittent-perf-problems/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
<!-- font awesome -->
<script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:doug.hunley@gmail.com"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">EXPLAINing intermittent perf problems</h1>
  <span class="post-date">
    28 Nov 2016,
    
    Reading time ~5 minutes<br />
    postgresql <br />
  </span>

  <p><img src="http://i0.kym-cdn.com/entries/icons/original/000/010/997/35s7cv.jpg" class="lleader" />We’ve all gotten the dreaded email/call from a user stating that a query is “slow sometimes”. If you’re lucky, the “sometimes” actually ends up being fairly consistent and you can fairly easily determine what’s happening (an errant cron job, for example). All too often though, the issue really is sporadic, fleeting, and indeterministic. So how do you track these down? And more importantly what do you do about them once found?</p>

<p>For starters, you as the DBA should have your PostgreSQL logging configured to log these slow performing queries. After all, you and the devs and the users can agree that all queries should complete in some measure of time (1 sec, 1 minute, etc). So, once you know what this acceptable elapsed time is, you can easily log any query that runs longer by just setting this in your <code class="language-plaintext highlighter-rouge">postgresql.conf</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">log_min_duration_statement</span> = <span class="m">1000</span>   <span class="c"># log anything running longer than 1s
</span></code></pre></div></div>

<p>And now, you have all queries with long run times logged automatically. And these show up nicely in your pgBadger reports too!</p>

<p>If you’re lucky, you’ll be able to use <code class="language-plaintext highlighter-rouge">EXPLAIN</code> to see why the query is behaving poorly. However, if your life is like mine, the explain plan will be reasonable and won’t have any smoking guns to speak of. Which means the performance is either load dependent or being influenced by other processes (something is blowing out your caches, for example). In these cases, what you really need is the <code class="language-plaintext highlighter-rouge">EXPLAIN</code> output from the very instant that it performed poorly. However, you can’t go back in time to get it. But what you can do is make use of the <code class="language-plaintext highlighter-rouge">auto_explain</code> module that ships with PostgreSQL.</p>

<p>In case the name wasn’t obvious enough, the <code class="language-plaintext highlighter-rouge">auto_explain</code> module causes PostgreSQL to automatically run <code class="language-plaintext highlighter-rouge">EXPLAIN</code> on queries according to thresholds that you configure. These automatically generated plans are then logged into the normal PostgreSQL logs. Let’s walk through setting it up and see how it works.</p>

<p>First, in your <code class="language-plaintext highlighter-rouge">postgresql.conf</code> we want to enable the module:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_preload_libraries</span> = <span class="s1">'auto_explain'</span>  <span class="c"># change requires restart
</span></code></pre></div></div>

<p>As stated, you will have to restart the postmaster to get the module to load. However, let’s configure it in <code class="language-plaintext highlighter-rouge">postgresql.conf</code> first:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Add settings for extensions here
#
# auto_explain
# http://www.postgresql.org/docs/current/static/auto-explain.html
</span><span class="n">auto_explain</span>.<span class="n">log_analyze</span> = <span class="n">true</span>
<span class="n">auto_explain</span>.<span class="n">log_timing</span> = <span class="n">true</span>
<span class="n">auto_explain</span>.<span class="n">log_verbose</span> = <span class="n">true</span>
<span class="n">auto_explain</span>.<span class="n">log_min_duration</span> = <span class="s1">'1000ms'</span>
<span class="n">auto_explain</span>.<span class="n">log_nested_statements</span> = <span class="n">true</span>
<span class="n">auto_explain</span>.<span class="n">log_buffers</span> = <span class="n">true</span>
<span class="c"># auto_explain
</span></code></pre></div></div>

<p>What we’ve done here is configure <code class="language-plaintext highlighter-rouge">auto_explain</code> to</p>

<ul>
  <li>use <code class="language-plaintext highlighter-rouge">EXPLAIN ANALYZE</code><sup>1</sup></li>
  <li>to use the <code class="language-plaintext highlighter-rouge">TIMING</code> option of <code class="language-plaintext highlighter-rouge">EXPLAIN</code></li>
  <li>to use the <code class="language-plaintext highlighter-rouge">VERBOSE</code> option of <code class="language-plaintext highlighter-rouge">EXPLAIN</code></li>
  <li>to log the plan for anything running longer than 1 second (matches <code class="language-plaintext highlighter-rouge">log_min_duration_statement</code>, above)</li>
  <li>to include statements inside a function to also be logged</li>
  <li>to use the <code class="language-plaintext highlighter-rouge">BUFFERS</code> option of <code class="language-plaintext highlighter-rouge">EXPLAIN</code></li>
</ul>

<p>As with most <code class="language-plaintext highlighter-rouge">GUC</code> in PostgreSQL, these can all be changed using <code class="language-plaintext highlighter-rouge">SET</code> in a given session, but we’re setting the defaults here. Now that we have them setup, let’s see what it looks like in practice.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span> <span class="nb">text</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">6</span><span class="p">.</span><span class="mi">022</span> <span class="n">ms</span>
<span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">10000</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">23</span><span class="p">.</span><span class="mi">565</span> <span class="n">ms</span>
</code></pre></div></div>

<p>We connected to PostgreSQL, created a test table, and then used <code class="language-plaintext highlighter-rouge">generate_series</code> to insert 10k rows. In our logs, the following were added:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">20</span>:<span class="m">30</span> <span class="n">EST</span> [<span class="m">28838</span>]: [<span class="m">18</span>-<span class="m">1</span>] <span class="n">user</span>=<span class="n">doug</span>,<span class="n">db</span>=<span class="n">doug</span>,<span class="n">app</span>=<span class="n">psql</span>,<span class="n">client</span>=[<span class="n">local</span>] <span class="n">LOG</span>:  <span class="n">duration</span>: <span class="m">33</span>.<span class="m">987</span> <span class="n">ms</span>  <span class="n">statement</span>: <span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">x</span>(<span class="n">t</span> <span class="n">text</span>);
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">20</span>:<span class="m">59</span> <span class="n">EST</span> [<span class="m">28838</span>]: [<span class="m">19</span>-<span class="m">1</span>] <span class="n">user</span>=<span class="n">doug</span>,<span class="n">db</span>=<span class="n">doug</span>,<span class="n">app</span>=<span class="n">psql</span>,<span class="n">client</span>=[<span class="n">local</span>] <span class="n">LOG</span>:  <span class="n">duration</span>: <span class="m">16</span>.<span class="m">461</span> <span class="n">ms</span>  <span class="n">plan</span>:
  <span class="n">Query</span> <span class="n">Text</span>: <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">x</span>(<span class="n">t</span>) <span class="n">SELECT</span> <span class="n">generate_series</span>(<span class="m">1</span>,<span class="m">10000</span>);
  <span class="n">Insert</span> <span class="n">on</span> <span class="n">public</span>.<span class="n">x</span>  (<span class="n">cost</span>=<span class="m">0</span>.<span class="m">00</span>..<span class="m">50</span>.<span class="m">02</span> <span class="n">rows</span>=<span class="m">1000</span> <span class="n">width</span>=<span class="m">32</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">16</span>.<span class="m">459</span>..<span class="m">16</span>.<span class="m">459</span> <span class="n">rows</span>=<span class="m">0</span> <span class="n">loops</span>=<span class="m">1</span>)
    <span class="n">Buffers</span>: <span class="n">shared</span> <span class="n">hit</span>=<span class="m">10085</span> <span class="n">read</span>=<span class="m">47</span> <span class="n">dirtied</span>=<span class="m">45</span>
    <span class="n">I</span>/<span class="n">O</span> <span class="n">Timings</span>: <span class="n">read</span>=<span class="m">0</span>.<span class="m">012</span>
    -&gt;  <span class="n">Subquery</span> <span class="n">Scan</span> <span class="n">on</span> <span class="s2">"*SELECT*"</span>  (<span class="n">cost</span>=<span class="m">0</span>.<span class="m">00</span>..<span class="m">50</span>.<span class="m">02</span> <span class="n">rows</span>=<span class="m">1000</span> <span class="n">width</span>=<span class="m">32</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">0</span>.<span class="m">010</span>..<span class="m">4</span>.<span class="m">755</span> <span class="n">rows</span>=<span class="m">10000</span> <span class="n">loops</span>=<span class="m">1</span>)
          <span class="n">Output</span>: <span class="s2">"*SELECT*"</span>.<span class="n">generate_series</span>
          -&gt;  <span class="n">Result</span>  (<span class="n">cost</span>=<span class="m">0</span>.<span class="m">00</span>..<span class="m">15</span>.<span class="m">02</span> <span class="n">rows</span>=<span class="m">1000</span> <span class="n">width</span>=<span class="m">4</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">0</span>.<span class="m">007</span>..<span class="m">1</span>.<span class="m">364</span> <span class="n">rows</span>=<span class="m">10000</span> <span class="n">loops</span>=<span class="m">1</span>)
                <span class="n">Output</span>: <span class="n">generate_series</span>(<span class="m">1</span>, <span class="m">10000</span>)
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">20</span>:<span class="m">59</span> <span class="n">EST</span> [<span class="m">28838</span>]: [<span class="m">20</span>-<span class="m">1</span>] <span class="n">user</span>=<span class="n">doug</span>,<span class="n">db</span>=<span class="n">doug</span>,<span class="n">app</span>=<span class="n">psql</span>,<span class="n">client</span>=[<span class="n">local</span>] <span class="n">LOG</span>:  <span class="n">duration</span>: <span class="m">23</span>.<span class="m">374</span> <span class="n">ms</span>  <span class="n">statement</span>: <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">x</span>(<span class="n">t</span>) <span class="n">SELECT</span> <span class="n">generate_series</span>(<span class="m">1</span>,<span class="m">10000</span>);
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">21</span>:<span class="m">00</span> <span class="n">EST</span> [<span class="m">30079</span>]: [<span class="m">1</span>-<span class="m">1</span>] <span class="n">user</span>=,<span class="n">db</span>=,<span class="n">app</span>=,<span class="n">client</span>= <span class="n">LOG</span>:  <span class="n">automatic</span> <span class="n">analyze</span> <span class="n">of</span> <span class="n">table</span> <span class="s2">"doug.public.x"</span> <span class="n">system</span> <span class="n">usage</span>: <span class="n">CPU</span> <span class="m">0</span>.<span class="m">00</span><span class="n">s</span>/<span class="m">0</span>.<span class="m">11</span><span class="n">u</span> <span class="n">sec</span> <span class="n">elapsed</span> <span class="m">0</span>.<span class="m">14</span> <span class="n">sec</span>
</code></pre></div></div>

<p>(Note that for illustrative purposes, I issued <code class="language-plaintext highlighter-rouge">SET auto_explain.log_min_duration = '0ms'</code>)</p>

<p>So, you can see that the <code class="language-plaintext highlighter-rouge">CREATE TABLE</code> didn’t log anything through the <code class="language-plaintext highlighter-rouge">auto_explain</code> module, but the <code class="language-plaintext highlighter-rouge">INSERT INTO</code> did. This is a boring example, so let’s try a <code class="language-plaintext highlighter-rouge">SELECT</code> against our table:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">x</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
<span class="err">┌───────┐</span>
<span class="err">│</span>   <span class="n">t</span>   <span class="err">│</span>
<span class="err">├───────┤</span>
<span class="err">│</span> <span class="mi">1</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mi">10</span>    <span class="err">│</span>
<span class="err">│</span> <span class="mi">100</span>   <span class="err">│</span>
<span class="err">│</span> <span class="mi">1000</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">10000</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1001</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1002</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1003</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1004</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1005</span>  <span class="err">│</span>
<span class="err">└───────┘</span>
<span class="p">(</span><span class="mi">10</span> <span class="k">rows</span><span class="p">)</span>

<span class="nb">Time</span><span class="p">:</span> <span class="mi">11</span><span class="p">.</span><span class="mi">982</span> <span class="n">ms</span>
</code></pre></div></div>

<p>and the logs look like:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">27</span>:<span class="m">38</span> <span class="n">EST</span> [<span class="m">322</span>]: [<span class="m">7</span>-<span class="m">1</span>] <span class="n">user</span>=,<span class="n">db</span>=,<span class="n">app</span>=,<span class="n">client</span>= <span class="n">LOG</span>:  <span class="n">checkpoint</span> <span class="n">starting</span>: <span class="n">time</span>
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">27</span>:<span class="m">46</span> <span class="n">EST</span> [<span class="m">322</span>]: [<span class="m">8</span>-<span class="m">1</span>] <span class="n">user</span>=,<span class="n">db</span>=,<span class="n">app</span>=,<span class="n">client</span>= <span class="n">LOG</span>:  <span class="n">checkpoint</span> <span class="n">complete</span>: <span class="n">wrote</span> <span class="m">75</span> <span class="n">buffers</span> (<span class="m">0</span>.<span class="m">0</span>%); <span class="m">0</span> <span class="n">transaction</span> <span class="n">log</span> <span class="n">file</span>(<span class="n">s</span>) <span class="n">added</span>, <span class="m">0</span> <span class="n">removed</span>, <span class="m">0</span> <span class="n">recycled</span>; <span class="n">write</span>=<span class="m">7</span>.<span class="m">569</span> <span class="n">s</span>, <span class="n">sync</span>=<span class="m">0</span>.<span class="m">092</span> <span class="n">s</span>, <span class="n">total</span>=<span class="m">7</span>.<span class="m">920</span> <span class="n">s</span>; <span class="n">sync</span> <span class="n">files</span>=<span class="m">23</span>, <span class="n">longest</span>=<span class="m">0</span>.<span class="m">092</span> <span class="n">s</span>, <span class="n">average</span>=<span class="m">0</span>.<span class="m">004</span> <span class="n">s</span>; <span class="n">distance</span>=<span class="m">685</span> <span class="n">kB</span>, <span class="n">estimate</span>=<span class="m">685</span> <span class="n">kB</span>
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">28</span>:<span class="m">48</span> <span class="n">EST</span> [<span class="m">28838</span>]: [<span class="m">21</span>-<span class="m">1</span>] <span class="n">user</span>=<span class="n">doug</span>,<span class="n">db</span>=<span class="n">doug</span>,<span class="n">app</span>=<span class="n">psql</span>,<span class="n">client</span>=[<span class="n">local</span>] <span class="n">LOG</span>:  <span class="n">duration</span>: <span class="m">11</span>.<span class="m">120</span> <span class="n">ms</span>  <span class="n">plan</span>:
  <span class="n">Query</span> <span class="n">Text</span>: <span class="n">SELECT</span> * <span class="n">FROM</span> <span class="n">x</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">t</span> <span class="n">LIMIT</span> <span class="m">10</span>;
  <span class="n">Limit</span>  (<span class="n">cost</span>=<span class="m">561</span>.<span class="m">10</span>..<span class="m">561</span>.<span class="m">12</span> <span class="n">rows</span>=<span class="m">10</span> <span class="n">width</span>=<span class="m">4</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">11</span>.<span class="m">073</span>..<span class="m">11</span>.<span class="m">073</span> <span class="n">rows</span>=<span class="m">10</span> <span class="n">loops</span>=<span class="m">1</span>)
    <span class="n">Output</span>: <span class="n">t</span>
    <span class="n">Buffers</span>: <span class="n">shared</span> <span class="n">hit</span>=<span class="m">45</span>
    -&gt;  <span class="n">Sort</span>  (<span class="n">cost</span>=<span class="m">561</span>.<span class="m">10</span>..<span class="m">586</span>.<span class="m">10</span> <span class="n">rows</span>=<span class="m">10000</span> <span class="n">width</span>=<span class="m">4</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">11</span>.<span class="m">072</span>..<span class="m">11</span>.<span class="m">072</span> <span class="n">rows</span>=<span class="m">10</span> <span class="n">loops</span>=<span class="m">1</span>)
          <span class="n">Output</span>: <span class="n">t</span>
          <span class="n">Sort</span> <span class="n">Key</span>: <span class="n">x</span>.<span class="n">t</span>
          <span class="n">Sort</span> <span class="n">Method</span>: <span class="n">top</span>-<span class="n">N</span> <span class="n">heapsort</span>  <span class="n">Memory</span>: <span class="m">25</span><span class="n">kB</span>
          <span class="n">Buffers</span>: <span class="n">shared</span> <span class="n">hit</span>=<span class="m">45</span>
          -&gt;  <span class="n">Seq</span> <span class="n">Scan</span> <span class="n">on</span> <span class="n">public</span>.<span class="n">x</span>  (<span class="n">cost</span>=<span class="m">0</span>.<span class="m">00</span>..<span class="m">345</span>.<span class="m">00</span> <span class="n">rows</span>=<span class="m">10000</span> <span class="n">width</span>=<span class="m">4</span>) (<span class="n">actual</span> <span class="n">time</span>=<span class="m">0</span>.<span class="m">018</span>..<span class="m">1</span>.<span class="m">224</span> <span class="n">rows</span>=<span class="m">10000</span> <span class="n">loops</span>=<span class="m">1</span>)
                <span class="n">Output</span>: <span class="n">t</span>
                <span class="n">Buffers</span>: <span class="n">shared</span> <span class="n">hit</span>=<span class="m">45</span>
<span class="m">2016</span>-<span class="m">11</span>-<span class="m">28</span> <span class="m">13</span>:<span class="m">28</span>:<span class="m">48</span> <span class="n">EST</span> [<span class="m">28838</span>]: [<span class="m">22</span>-<span class="m">1</span>] <span class="n">user</span>=<span class="n">doug</span>,<span class="n">db</span>=<span class="n">doug</span>,<span class="n">app</span>=<span class="n">psql</span>,<span class="n">client</span>=[<span class="n">local</span>] <span class="n">LOG</span>:  <span class="n">duration</span>: <span class="m">11</span>.<span class="m">813</span> <span class="n">ms</span>  <span class="n">statement</span>: <span class="n">SELECT</span> * <span class="n">FROM</span> <span class="n">x</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">t</span> <span class="n">LIMIT</span> <span class="m">10</span>;
</code></pre></div></div>

<p>(You can safely ignore the checkpoint lines at the top there)</p>

<p>There you have both the statement we ran, and the full <code class="language-plaintext highlighter-rouge">EXPLAIN</code> plan. You can see we did a sequential scan on the table (looks like it was all in the <code class="language-plaintext highlighter-rouge">shared_buffers</code> too) and then we passed that up to a <code class="language-plaintext highlighter-rouge">sort</code> node for an in-memory sort, and then passed that result set up to the <code class="language-plaintext highlighter-rouge">limit</code> node.</p>

<p>While this is a stupid simple example, I hope you can see that having this in production for large, complicated queries will allow you to better diagnose issues. For example, simply doing a manual <code class="language-plaintext highlighter-rouge">EXPLAIN ANALYZE</code> on the same query and seeing that you get a different plan is potentially enough to rule out (or in) certain culprits for the intermittent performance issue.
<br />
<br />
<br />
<br />
<sup>1</sup> - This option causes the postmaster to collect info on <em>every</em> statement executed, even if <code class="language-plaintext highlighter-rouge">auto_explain</code> isn’t going to log it. It has a measurable impact on overall performance. Please test on your workload and decide for yourself if the overhead is worth the trade-off</p>

</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
