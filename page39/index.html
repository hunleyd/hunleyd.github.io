<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Doug's Dabblings &middot; Quick thoughts on stuff I'm playing with
    
  </title>

  
  <link rel="canonical" href="/page39/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/08/24/Where-Not-To-Put-Your-Tablespaces/">
        Where Not To Put Your Tablespaces
      </a>
    </h1>

    <span class="post-date">24 Aug 2016</span>

    <p>From the PostgreSQL <a href="https://www.postgresql.org/docs/current/static/manage-ag-tablespaces.html">docs</a>:</p>

<blockquote>
  <p>Tablespaces in PostgreSQL allow database administrators to define locations in the file system where the files representing database objects can be stored. Once created, a tablespace can be referred to by name when creating database objects.</p>
</blockquote>

<blockquote>
  <p>By using tablespaces, an administrator can control the disk layout of a PostgreSQL installation. This is useful in at least two ways. First, if the partition or volume on which the cluster was initialized runs out of space and cannot be extended, a tablespace can be created on a different partition and used until the system can be reconfigured.</p>
</blockquote>

<blockquote>
  <p>Second, tablespaces allow an administrator to use knowledge of the usage pattern of database objects to optimize performance. For example, an index which is very heavily used can be placed on a very fast, highly available disk, such as an expensive solid state device. At the same time a table storing archived data which is rarely used or not performance critical could be stored on a less expensive, slower disk system.</p>
</blockquote>

<p>As you can see, while not as powerful as tablespaces in, say, Oracle, they do still have their uses in PostgreSQL. You can use them to make use of different filesystems, or different mount options, or different disk types and, in doing so, intelligently apply performance characteristics to subsets of your data. For example, you could put your highest volume tables in a tablespace that is mounted from SSDs while the rest of your db is mounted from spinning rust.</p>

<p>Sounds decent, right? Now you before you go off and be “clever” and create an SSD-backed mountpoint for your new tablespace, understand that there are places you <em>should not</em> create the tablespace. You shouldn’t create tablespaces on any kind of ephemeral storage, for example on a <code class="language-plaintext highlighter-rouge">tmpfs</code> or a <code class="language-plaintext highlighter-rouge">ramfs</code> or similar. <em>You also should not create your new tablespaces under $PGDATA</em>. Yes, I’m aware there is <code class="language-plaintext highlighter-rouge">$PGDATA/pg_tblspc</code> but that directory is <em>not for you</em>. The system will auto-populate that directory with pointers to the real location of your tablespaces!</p>

<p>So what happens when you create a tablespace inside $PGDATA? Let’s find out. First, we’ll create the directory for the tablespace:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nv">$PGDATA</span>/tablespaces
<span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$PGDATA</span>/tablespaces
<span class="nv">$ </span><span class="nb">pwd</span>
/Users/doug.hunley/pgdata/tablespaces
</code></pre></div></div>

<p>And we see that nothing bad has happened yet. So, let’s pop over into <code class="language-plaintext highlighter-rouge">psql</code> and actually create the tablespace:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="k">CREATE</span> <span class="n">TABLESPACE</span> <span class="n">ts1</span> <span class="k">LOCATION</span> <span class="s1">'/Users/doug.hunley/pgdata/tablespaces'</span><span class="p">;</span>
<span class="n">WARNING</span><span class="p">:</span>  <span class="mi">42</span><span class="n">P17</span><span class="p">:</span> <span class="n">tablespace</span> <span class="k">location</span> <span class="n">should</span> <span class="k">not</span> <span class="n">be</span> <span class="n">inside</span> <span class="n">the</span> <span class="k">data</span> <span class="n">directory</span>
<span class="k">LOCATION</span><span class="p">:</span>  <span class="n">CreateTableSpace</span><span class="p">,</span> <span class="n">tablespace</span><span class="p">.</span><span class="k">c</span><span class="p">:</span><span class="mi">295</span>
<span class="k">CREATE</span> <span class="n">TABLESPACE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">797</span> <span class="n">ms</span>
</code></pre></div></div>

<p>We get a warning (not an error, for some reason) but it works and all appears fine. Now you can spend minutes/days/months/years using your new tablespace and never notice that you’ve got a problem. So where does the problem come in?</p>

<p>Let’s try to make a backup of our cluster:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pg_basebackup <span class="nt">-D</span> pgdata2 <span class="nt">-Fp</span> <span class="nt">-R</span> <span class="nt">-Xs</span> <span class="nt">-c</span> fast <span class="nt">-l</span> <span class="s1">'clone for slave'</span> <span class="nt">-P</span> <span class="nt">-v</span>
transaction log start point: 2/17000028 on timeline 1
pg_basebackup: directory <span class="s2">"/Users/doug.hunley/pgdata/tablespaces"</span> exists but is not empty
</code></pre></div></div>

<p>There it is.</p>

<p>When creating the backup, it tries to ensure the tablespace location is the same, but then it won’t write to a non-empty directory. My example is two different $PGDATA locations on the same box, but the issue is the same when using different machines because <code class="language-plaintext highlighter-rouge">pg_basebackup</code> backs up <em>everything</em> in $PGDATA which means your tablespace directory gets cloned before it gets to the actual cloning of the data in the tablespace so you end up with “stuff” in the dir, making it non-empty. Which gives you the same error and output.</p>

<p>OK, so it breaks backups. I can work around that by using another backup method. What else?</p>

<p>How about using <code class="language-plaintext highlighter-rouge">pg_upgrade</code> to do an upgrade? No matter if you run in <code class="language-plaintext highlighter-rouge">link</code> mode or not, <code class="language-plaintext highlighter-rouge">pg_upgrade</code> <em>will not move</em> your tablespace location. So you may have <code class="language-plaintext highlighter-rouge">~/pgdata95</code> and <code class="language-plaintext highlighter-rouge">~/pgdata96</code> after the upgrade, but your tablespaces <em>are still in</em> <code class="language-plaintext highlighter-rouge">~/pgdata95/tablespaces</code>. So, as per the <a href="https://www.postgresql.org/docs/current/static/pgupgrade.html">docs</a>:</p>

<blockquote>
  <p>Once you are satisfied with the upgrade, you can delete the old cluster’s data directories by running the script mentioned when pg_upgrade completes.</p>
</blockquote>

<p>And <em>boom</em> you’ve just deleted your tablespaces off disk. Congratulations!</p>

<p>So there you have it. Two very good reasons to not create tablespaces inside $PGDATA. Please, don’t do this. Everyone who admins that cluster going forward will thank you.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page40">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page38">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
