<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Doug's Dabblings &middot; Quick thoughts on stuff I'm playing with
    
  </title>

  
  <link rel="canonical" href="/page11/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/07/pgBouncer-and-auth-pass-thru/">
        pgBouncer and auth pass-thru
      </a>
    </h1>

    <span class="post-date">07 Aug 2018</span>

    <p>I’ve noticed several individuals inquiring lately about pgBouncer and how they can avoid putting all users and their passwords in it’s <code class="language-plaintext highlighter-rouge">auth_file</code>. After the most recent such inquiry (hi Richard!) I decided I’d write this post to
hopefully make it clearer how to use ‘pass-thru auth’ and avoid maintaining your users and their passwords in an external file. So let’s see what this takes, shall we?</p>

<p>First, install pgBouncer as per your OS (<code class="language-plaintext highlighter-rouge">yum</code>, <code class="language-plaintext highlighter-rouge">apt</code>, <code class="language-plaintext highlighter-rouge">brew</code>, etc):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>brew <span class="nb">install </span>pgbouncer
Updating Homebrew...
<span class="o">==&gt;</span> Auto-updated Homebrew!
Updated 1 tap <span class="o">(</span>homebrew/core<span class="o">)</span><span class="nb">.</span>
<span class="o">==&gt;</span> Updated Formulae
&lt;snip&gt;
<span class="o">==&gt;</span> Downloading https://homebrew.bintray.com/bottles/pgbouncer-1.8.1.high_sierra
<span class="c">######################################################################## 100.0%</span>
<span class="o">==&gt;</span> Pouring pgbouncer-1.8.1.high_sierra.bottle.tar.gz
<span class="o">==&gt;</span> Caveats
The config file: /usr/local/etc/pgbouncer.ini is <span class="k">in </span>the <span class="s2">"ini"</span> format and you
will need to edit it <span class="k">for </span>your particular setup. See:
https://pgbouncer.github.io/config.html

The auth_file option should point to the /usr/local/etc/userlist.txt file which
can be populated by the /usr/local/opt/pgbouncer/bin/mkauth.py script.

To have launchd start pgbouncer now and restart at login:
  brew services start pgbouncer
Or, <span class="k">if </span>you <span class="k">do </span>not want/need a background service you can just run:
  pgbouncer <span class="nt">-q</span> /usr/local/etc/pgbouncer.ini
<span class="o">==&gt;</span> Summary
🍺  /usr/local/Cellar/pgbouncer/1.8.1: 17 files, 399.9KB
</code></pre></div></div>

<p>Great, so now we have pgBouncer installed.</p>

<p>To make life easier on ourselves, we’re going to <strong>temporarily</strong> enable trusted local socket connections in our <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># TYPE  DATABASE        USER            ADDRESS                 METHOD
</span>
<span class="c"># "local" is for Unix domain socket connections only
</span><span class="n">local</span>   <span class="n">all</span>             <span class="n">all</span> <span class="n">trust</span>
</code></pre></div></div>

<p>Right now, this is the only line in my <code class="language-plaintext highlighter-rouge">pg_hba.conf</code>. Let’s SIGHUP the postmaster so it takes affect:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pg_ctl <span class="nt">-D</span> <span class="nv">$PGDATA</span> reload
server signaled
</code></pre></div></div>

<p>And test it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">unset </span>PGPASSWORD <span class="p">;</span> psql <span class="nt">-U</span> doug <span class="nt">-d</span> doug <span class="nt">-c</span> <span class="s2">"select now();"</span>
┌───────────────────────────────┐
│              now              │
├───────────────────────────────┤
│ 2018-08-07 13:19:06.343245-04 │
└───────────────────────────────┘
<span class="o">(</span>1 row<span class="o">)</span>

Time: 1.959 ms
</code></pre></div></div>

<p>OK, we can connect without issue.</p>

<p>Let’s configure pgBouncer now. As per the output above, I need to edit <code class="language-plaintext highlighter-rouge">/usr/local/etc/pgbouncer.ini</code> but yours is probably in plain old <code class="language-plaintext highlighter-rouge">/etc</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">databases</span>]

; <span class="n">any</span> <span class="n">db</span> <span class="n">over</span> <span class="n">Unix</span> <span class="n">socket</span>
* =

[<span class="n">pgbouncer</span>]

<span class="n">logfile</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">pgbouncer</span>.<span class="n">log</span>
<span class="n">pidfile</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">pgbouncer</span>.<span class="n">pid</span>

; <span class="n">IP</span> <span class="n">address</span> <span class="n">or</span> * <span class="n">which</span> <span class="n">means</span> <span class="n">all</span> <span class="n">IPs</span>
<span class="n">listen_addr</span> = <span class="m">127</span>.<span class="m">0</span>.<span class="m">0</span>.<span class="m">1</span>
<span class="n">listen_port</span> = <span class="m">6432</span>

<span class="n">unix_socket_dir</span> = /<span class="n">tmp</span>

; <span class="n">any</span>, <span class="n">trust</span>, <span class="n">plain</span>, <span class="n">crypt</span>, <span class="n">md5</span>, <span class="n">cert</span>, <span class="n">hba</span>, <span class="n">pam</span>
<span class="n">auth_type</span> = <span class="n">trust</span>
<span class="n">auth_file</span> = /<span class="n">Users</span>/<span class="n">doug</span>/<span class="n">userlist</span>.<span class="n">txt</span>

<span class="n">admin_users</span> = <span class="n">doug</span>

<span class="n">stats_users</span> = <span class="n">doug</span>

<span class="n">pool_mode</span> = <span class="n">transaction</span>

<span class="n">server_reset_query</span> = <span class="n">DISCARD</span> <span class="n">ALL</span>


<span class="n">max_client_conn</span> = <span class="m">100</span>

<span class="n">default_pool_size</span> = <span class="m">20</span>
</code></pre></div></div>

<p>As you can see, we’re gonna pass connections to any db back to the postmaster via a local socket. I put the logs in my <code class="language-plaintext highlighter-rouge">$HOME</code> for ease of use. I put the <code class="language-plaintext highlighter-rouge">auth_file</code> in my <code class="language-plaintext highlighter-rouge">$HOME</code> as well. Then I set myself up as both an admin and stats
user. I changed the mode into <strong>transaction</strong> which is <em>usually</em> the mode you want. Now, I add myself to the auth_file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'"doug" "md5540094bd8172cd963fdfa773fe44b488"'</span> <span class="o">&gt;</span> userlist.txt
</code></pre></div></div>

<p>(NOTE: I did a select on pg_shadow as a SUPERUSER to get these values.)</p>

<p>And start pgBouncer:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pgbouncer /usr/local/etc/pgbouncer.ini
2018-08-07 13:43:46.453 92057 LOG File descriptor limit: 7168 <span class="o">(</span>H:-1<span class="o">)</span>, max_client_conn: 90, max fds possible: 100
2018-08-07 13:43:46.455 92057 LOG listening on 127.0.0.1:6432
2018-08-07 13:43:46.455 92057 LOG listening on unix:/tmp/.s.PGSQL.6432
2018-08-07 13:43:46.455 92057 LOG process up: pgbouncer 1.8.1, libevent 2.1.8-stable <span class="o">(</span>kqueue<span class="o">)</span>, adns: evdns2, tls: OpenSSL 1.0.2o  27 Mar 2018
</code></pre></div></div>

<p>Now, we see if we can connect to pgBouncer’s internal db:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-X</span>
psql <span class="o">(</span>10.4, server 1.8.1/bouncer<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pgbouncer</span><span class="o">=#</span> <span class="k">show</span> <span class="n">pools</span><span class="p">;</span>
 <span class="k">database</span>  <span class="o">|</span>   <span class="k">user</span>    <span class="o">|</span> <span class="n">cl_active</span> <span class="o">|</span> <span class="n">cl_waiting</span> <span class="o">|</span> <span class="n">sv_active</span> <span class="o">|</span> <span class="n">sv_idle</span> <span class="o">|</span> <span class="n">sv_used</span> <span class="o">|</span> <span class="n">sv_tested</span> <span class="o">|</span> <span class="n">sv_login</span> <span class="o">|</span> <span class="n">maxwait</span> <span class="o">|</span> <span class="n">maxwait_us</span> <span class="o">|</span> <span class="n">pool_mode</span>
<span class="c1">-----------+-----------+-----------+------------+-----------+---------+---------+-----------+----------+---------+------------+-----------</span>
 <span class="n">pgbouncer</span> <span class="o">|</span> <span class="n">pgbouncer</span> <span class="o">|</span>         <span class="mi">1</span> <span class="o">|</span>          <span class="mi">0</span> <span class="o">|</span>         <span class="mi">0</span> <span class="o">|</span>       <span class="mi">0</span> <span class="o">|</span>       <span class="mi">0</span> <span class="o">|</span>         <span class="mi">0</span> <span class="o">|</span>        <span class="mi">0</span> <span class="o">|</span>       <span class="mi">0</span> <span class="o">|</span>          <span class="mi">0</span> <span class="o">|</span> <span class="k">statement</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</code></pre></div></div>

<p>Success!</p>

<p>Now, can we connect to one of our PostgreSQL dbs through pgBouncer:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> doug
psql <span class="o">(</span>10.4<span class="o">)</span>
Type <span class="s2">"help"</span> <span class="k">for </span>help.

<span class="o">(</span>doug@127.0.0.1:6432/doug[92825]<span class="o">)</span> <span class="c">#</span>
</code></pre></div></div>

<p>Huzzah!</p>

<p>We will now alter <code class="language-plaintext highlighter-rouge">pgbouncer.ini</code> and set <code class="language-plaintext highlighter-rouge">auth_type = md5</code> and edit <code class="language-plaintext highlighter-rouge">pg_hba.conf</code> to use md5 as well to make sure we’re not passing around plaintext passwords. Our retest looks like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> ^local <span class="nv">$PGDATA</span>/pg_hba.conf
<span class="nb">local   </span>all             all md5

<span class="nv">$ </span>pg_ctl <span class="nt">-D</span> <span class="nv">$PGDATA</span> reload
server signaled
doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> doug
Password:
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psql</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">97966</span><span class="p">])</span> <span class="err">\</span><span class="n">q</span>
</code></pre></div></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-X</span>
Password:
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psql</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">,</span> <span class="n">server</span> <span class="mi">1</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">bouncer</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>
<span class="n">pgbouncer</span><span class="o">=</span> <span class="err">\</span><span class="n">q</span>
</code></pre></div></div>

<p>Which, as you can see, we were now password prompted both times!</p>

<p>Now, that we know it all works, we can go about changing things to not expose users through
the <code class="language-plaintext highlighter-rouge">auth_file</code>. First, we’ll create a <code class="language-plaintext highlighter-rouge">pgbouncer</code> user on our db, then we will
create a SECURITY DEFINER function will allow the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user to
(essentially) ‘sudo’ as a superuser to look at the <code class="language-plaintext highlighter-rouge">pg_shadow</code> table, and finally
we will ensure only our <code class="language-plaintext highlighter-rouge">pgbouncer</code> user can execute that function:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">CREATE</span> <span class="k">ROLE</span> <span class="n">pgbouncer</span> <span class="k">ENCRYPTED</span> <span class="n">PASSWORD</span> <span class="s1">'secret'</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">ROLE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">4</span><span class="p">.</span><span class="mi">102</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">GRANT</span> <span class="k">CONNECT</span> <span class="k">ON</span> <span class="k">DATABASE</span> <span class="n">doug</span> <span class="k">TO</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">GRANT</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">13</span><span class="p">.</span><span class="mi">531</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">pgbouncer</span> <span class="n">LOGIN</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="k">ROLE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">6</span><span class="p">.</span><span class="mi">457</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="k">in</span> <span class="n">i_username</span> <span class="nb">text</span><span class="p">,</span> <span class="k">out</span> <span class="n">uname</span> <span class="nb">text</span><span class="p">,</span> <span class="k">out</span> <span class="n">phash</span> <span class="nb">text</span><span class="p">)</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="o">-</span> <span class="o">&gt;</span> <span class="k">RETURNS</span> <span class="n">record</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="k">BEGIN</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">SELECT</span> <span class="n">usename</span><span class="p">,</span> <span class="n">passwd</span> <span class="k">FROM</span> <span class="n">pg_catalog</span><span class="p">.</span><span class="n">pg_shadow</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">WHERE</span> <span class="n">usename</span> <span class="o">=</span> <span class="n">i_username</span> <span class="k">INTO</span> <span class="n">uname</span><span class="p">,</span> <span class="n">phash</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span>     <span class="k">RETURN</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="k">END</span><span class="p">;</span>
<span class="p">[</span><span class="k">more</span><span class="p">]</span> <span class="err">$</span> <span class="o">&gt;</span> <span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span> <span class="k">SECURITY</span> <span class="k">DEFINER</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">FUNCTION</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">21</span><span class="p">.</span><span class="mi">219</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">REVOKE</span> <span class="k">ALL</span> <span class="k">ON</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> <span class="k">FROM</span> <span class="k">public</span><span class="p">,</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">REVOKE</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">330</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">92825</span><span class="p">])</span> <span class="o">#</span> <span class="k">GRANT</span> <span class="k">EXECUTE</span> <span class="k">ON</span> <span class="k">FUNCTION</span> <span class="k">public</span><span class="p">.</span><span class="n">user_lookup</span><span class="p">(</span><span class="nb">text</span><span class="p">)</span> <span class="k">TO</span> <span class="n">pgbouncer</span><span class="p">;</span>
<span class="k">GRANT</span>
<span class="nb">Time</span><span class="p">:</span> <span class="mi">7</span><span class="p">.</span><span class="mi">572</span> <span class="n">ms</span>
</code></pre></div></div>

<p>(NOTE: Astute readers will note I’m connected as ‘doug’ to the db. This works cause in my setup that is a SUPERUSER. You should probably use the ‘postgres’ account.)</p>

<p>And, let’s tell PgBouncer to use this function:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> ^auth /usr/local/etc/pgbouncer.ini
auth_type <span class="o">=</span> md5
auth_file <span class="o">=</span> /Users/doug/userlist.txt
auth_user <span class="o">=</span> pgbouncer
auth_query <span class="o">=</span> SELECT <span class="k">*</span> FROM public.user_lookup<span class="o">(</span><span class="nv">$1</span><span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<p>And let’s edit our <code class="language-plaintext highlighter-rouge">auth_file</code> to only contain the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user’s info:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; <span class="nb">cat </span>userlist.txt
<span class="s2">"pgbouncer"</span> <span class="s2">"md509d12ff67352814e4c467c7f55a3a1d7"</span>
</code></pre></div></div>

<p>Restart pgBouncer, and let’s recheck:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> doug                      2
Password:
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psql</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">6432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">7076</span><span class="p">])</span> <span class="o">#</span> <span class="k">select</span> <span class="n">now</span><span class="p">();</span>
<span class="err">┌───────────────────────────────┐</span>
<span class="err">│</span>              <span class="n">now</span>              <span class="err">│</span>
<span class="err">├───────────────────────────────┤</span>
<span class="err">│</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span> <span class="mi">14</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">45</span><span class="p">.</span><span class="mi">938919</span><span class="o">-</span><span class="mi">04</span> <span class="err">│</span>
<span class="err">└───────────────────────────────┘</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>

<span class="nb">Time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">438</span> <span class="n">ms</span>
</code></pre></div></div>

<p>It works! But what about the pgBouncer internal db?</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer
psql: ERROR:  No such user: doug
</code></pre></div></div>

<p>Well, that makes sense. The <code class="language-plaintext highlighter-rouge">auth_file</code> only has a <code class="language-plaintext highlighter-rouge">pgbouncer</code> user. So, let’s edit the <code class="language-plaintext highlighter-rouge">pgbouncer.ini</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> <span class="s1">'_users'</span> /usr/local/etc/pgbouncer.ini
admin_users <span class="o">=</span> pgbouncer
stats_users <span class="o">=</span> pgbouncer
</code></pre></div></div>

<p>Retart pgBouncer once more and check:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doug@ReturnOfTheMac ~&gt; psql <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6432 <span class="nt">-d</span> pgbouncer <span class="nt">-U</span> pgbouncer <span class="nt">-X</span>
Password <span class="k">for </span>user pgbouncer:
</code></pre></div></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">psql</span> <span class="p">(</span><span class="mi">10</span><span class="p">.</span><span class="mi">4</span><span class="p">,</span> <span class="n">server</span> <span class="mi">1</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">1</span><span class="o">/</span><span class="n">bouncer</span><span class="p">)</span>
<span class="k">Type</span> <span class="nv">"help"</span> <span class="k">for</span> <span class="n">help</span><span class="p">.</span>

<span class="n">pgbouncer</span><span class="o">=#</span> <span class="k">show</span> <span class="n">clients</span><span class="p">;</span>
 <span class="k">type</span> <span class="o">|</span>   <span class="k">user</span>    <span class="o">|</span> <span class="k">database</span>  <span class="o">|</span> <span class="k">state</span>  <span class="o">|</span>   <span class="n">addr</span>    <span class="o">|</span> <span class="n">port</span>  <span class="o">|</span> <span class="n">local_addr</span> <span class="o">|</span> <span class="n">local_port</span> <span class="o">|</span>    <span class="n">connect_time</span>     <span class="o">|</span>    <span class="n">request_time</span>     <span class="o">|</span> <span class="n">wait</span> <span class="o">|</span> <span class="n">wait_us</span> <span class="o">|</span>      <span class="n">ptr</span>       <span class="o">|</span> <span class="n">link</span> <span class="o">|</span> <span class="n">remote_pid</span> <span class="o">|</span> <span class="n">tls</span>
<span class="c1">------+-----------+-----------+--------+-----------+-------+------------+------------+---------------------+---------------------+------+---------+----------------+------+------------+-----</span>
 <span class="k">C</span>    <span class="o">|</span> <span class="n">pgbouncer</span> <span class="o">|</span> <span class="n">pgbouncer</span> <span class="o">|</span> <span class="n">active</span> <span class="o">|</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span> <span class="o">|</span> <span class="mi">54191</span> <span class="o">|</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>  <span class="o">|</span>       <span class="mi">6432</span> <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span> <span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">03</span> <span class="o">|</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span> <span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">06</span> <span class="o">|</span>    <span class="mi">0</span> <span class="o">|</span>       <span class="mi">0</span> <span class="o">|</span> <span class="mi">0</span><span class="n">x7fa082005010</span> <span class="o">|</span>      <span class="o">|</span>          <span class="mi">0</span> <span class="o">|</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</code></pre></div></div>

<p>And we’re golden!</p>

<p>You can connect to pgBouncer internally using the <code class="language-plaintext highlighter-rouge">pgbouncer</code> user, and you can connect to our normal PostgreSQL db as any valid user and it uses our function to do the auth!</p>

<p>To complete this setup, we’re gonna move PostgreSQL to port <code class="language-plaintext highlighter-rouge">5433</code> and pgBouncer to port <code class="language-plaintext highlighter-rouge">5432</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep </span>port /usr/local/etc/pgbouncer.ini
listen_port <span class="o">=</span> 5432
doug@ReturnOfTheMac ~&gt; <span class="nb">grep </span>port <span class="nv">$PGDATA</span>/postgresql.conf
port <span class="o">=</span> 5433				<span class="c"># (change requires restart)</span>
</code></pre></div></div>

<p>So now, if someone tries to connect to our PostgreSQL on the default TCP/IP port, it goes through PgBouncer transparently (and then pgBouncer connects locally via a socket). Our users/apps are none the wiser, and us DBAs can always <code class="language-plaintext highlighter-rouge">ssh</code> into the box and connect directly to PostgreSQL via socket if needed. And we’re not exposing any user/app passwords in a text file on the OS.</p>

<p>WIN WIN</p>

<p>One final note: this is only working for the ‘doug’ database currently. If I wanted this to also work for another database, say ‘postgres’ or ‘prod_app’ then I would need to GRANT CONNECT on those dbs to ‘pgbouncer’ <strong>and</strong> would need to create my function in them as well.</p>

<p>☮️</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page12">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page10">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
