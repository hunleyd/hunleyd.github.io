<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Latest Posts &#8211; Douglas J Hunley</title>
<meta name="description" content="Describe this nonsense.">
<meta name="keywords" content="Jekyll, theme, themes, responsive, blog, modern">

<!-- Twitter Cards -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="/images/abstract-1.jpg">

<meta name="twitter:title" content="Latest Posts">
<meta name="twitter:description" content="Describe this nonsense.">
<meta name="twitter:creator" content="@hunleyd">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Latest Posts">
<meta property="og:description" content="Describe this nonsense.">
<meta property="og:url" content="/index.html">
<meta property="og:site_name" content="Douglas J Hunley">





<link rel="canonical" href="/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Douglas J Hunley Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post-index" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<NAV id="dl-menu" class="dl-menuwrapper" role="navigation">
  <BUTTON class="dl-trigger">
    Open Menu
  </BUTTON>
  <UL class="dl-menu">
    <LI>
      <A href="/">Home</A>
    </LI>
    <LI>
      <A href="#">About</A>
      <UL class="dl-submenu">
        <LI>
          <IMG src="/images/avatar.jpg" alt="Douglas J Hunley photo" class="author-photo" />
          <H4>Douglas J Hunley</H4>
          <P>Linux Sys Admin, Gentoo user, PostgreSQL advocate, Android fanboi, OSS supporter, PlayStation gamer</P>
        </LI>
        <LI>
          <A href="/about/"><SPAN class="btn btn-inverse">Learn More</SPAN></A>
        </LI>
        
          <LI>
            <A href="https://dhunley.deviantart.com"><I class="fa fa-deviantart" aria-hidden="true"></I> DeviantArt</A>
          </LI>
        
        
          <LI>
            <A href="mailto:douglas.hunley@gmail.com"><I class="fa fa-envelope" aria-hidden="true"></I> Email</A>
          </LI>
        
        
          <LI>
            <A href="https://facebook.com/douglas.j.hunley"><I class="fa fa-facebook" aria-hidden="true"></I> Facebook</A>
          </LI>
        
        
        
          <LI>
            <A href="https://github.com/hunleyd"><I class="fa fa-github" aria-hidden="true"></I> GitHub</A>
          </LI>
        
        
          <LI>
            <A href="https://google.com/+DouglasHunley"><I class="fa fa-google-plus" aria-hidden="true"></I> Google+</A>
          </LI>
        
        
          <LI>
            <A href="https://instagram.com/doughunley"><I class="fa fa-instagram" aria-hidden="true"></I> Instagram</A>
          </LI>
        
        
          <LI>
            <A href="https://linkedin.com/in/dhunley"><I class="fa fa-linkedin" aria-hidden="true"></I> LinkedIn</A>
          </LI>
        
        
          <LI>
            <A href="https://meetup.com/members/43608152"><I class="fa fa-meetup" aria-hidden="true"></I> MeetUp</A>
          </LI>
        
        
          <LI>
            <A href="https://reddit.com/u/hunleyd"><I class="fa fa-reddit-alien" aria-hidden="true"></I> Reddit</A>
          </LI>
        
        
        
        
          <LI>
            <A href="https://twitter.com/hunleyd"><I class="fa fa-twitter" aria-hidden="true"></I> Twitter</A>
          </LI>
        
        
          <LI>
            <A href="https://youtube.com/user/doughunley"><I class="fa fa-youtube" aria-hidden="true"></I> YouTube</A>
          </LI>
        
      </UL><!-- /.dl-submenu -->
    </LI>
    <LI>
      <A href="#">Posts</A>
      <UL class="dl-submenu">
        <LI>
          <A href="/posts/">All Posts</A>
        </LI>
        <LI>
          <A href="/tags/">All Tags</A>
        </LI>
      </UL>
    </LI>
    
  </UL><!-- /.dl-menu -->
</NAV><!-- /.dl-menuwrapper -->


<div class="entry-header">
  
  
    <div class="entry-image">
      <img src="/images/abstract-1.jpg" alt="Latest Posts">
    </div><!-- /.entry-image -->
  
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Douglas J Hunley</h1>
      <h2>Latest Posts</h2>
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->

<div id="main" role="main">
  
  <ARTICLE class="hentry">
    <HEADER>
      
        <DIV class="entry-image-index">
          <A href="/posts/New-look-same-content/" title="New look, same content"><IMG src="/images/blog.png" alt="New look, same content" /></A>
        </DIV><!-- /.entry-image -->
      
      <DIV class="entry-meta">
        <SPAN class="entry-date date published updated">
          <TIME datetime="2017-01-17T09:26:51-05:00" />
            <A href="/posts/New-look-same-content/">January 17, 2017</A>
          </TIME>
        </SPAN>
        <SPAN class="author vcard">
          <SPAN class="fn">
            <A href="/about/" title="About Douglas J Hunley">Douglas J Hunley</A>
          </SPAN>
        </SPAN>
        
          <SPAN class="entry-reading-time">
            <I class="fa fa-clock-o"></i>
            
Reading time ~1 minute
          </SPAN><!-- /.entry-reading-time -->
        
      </DIV><!-- /.entry-meta -->
      
        <H1 class="entry-title">
          <A href="/posts/New-look-same-content/" rel="bookmark" title="New look, same content" itemprop="url">New look, same content</A>
        </H1>
      
    </HEADER>
    <DIV class="entry-content">
      <p><img class="lleader" src="http://www.awesome-t-shirts.com/img/T-shirts/you-look-different-not-better-just-different.jpg" />As you’ve probably noticed, I’ve launched the new blog design. Everything that was here should still be here, but it might have moved. Sorry, but I broke the old permalinks. Bad blogger! However, I now have everything <em>exactly</em> where I want it, so it shouldn’t ever change again. Famous last words, right there :)</p>

<p>So anyway, let me know if you find issues w/ the site. I’m aware of some small CSS fuckery here and there, but I got tired of beating my head against it honestly. If anyone wants to tell me what’s wrong with it and how to fix it, I’ll buy you a virtual beer. If you want to let your opinion known about the new design (nice! it sucks! meh.) feel free to hit me up too. If enough people kvetch, I’ll tweak it.</p>

<p>Enjoy or something.</p>

    </DIV><!-- /.entry-content -->
  </ARTICLE><!-- /.hentry -->

  <ARTICLE class="hentry">
    <HEADER>
      
        <DIV class="entry-image-index">
          <A href="/posts/changes-to-the-blog/" title="Changes to the blog"><IMG src="/images/blog.png" alt="Changes to the blog" /></A>
        </DIV><!-- /.entry-image -->
      
      <DIV class="entry-meta">
        <SPAN class="entry-date date published updated">
          <TIME datetime="2016-12-02T08:48:42-05:00" />
            <A href="/posts/changes-to-the-blog/">December 02, 2016</A>
          </TIME>
        </SPAN>
        <SPAN class="author vcard">
          <SPAN class="fn">
            <A href="/about/" title="About Douglas J Hunley">Douglas J Hunley</A>
          </SPAN>
        </SPAN>
        
          <SPAN class="entry-reading-time">
            <I class="fa fa-clock-o"></i>
            
Reading time ~1 minute
          </SPAN><!-- /.entry-reading-time -->
        
      </DIV><!-- /.entry-meta -->
      
        <H1 class="entry-title">
          <A href="/posts/changes-to-the-blog/" rel="bookmark" title="Changes to the blog" itemprop="url">Changes to the blog</A>
        </H1>
      
    </HEADER>
    <DIV class="entry-content">
      <p><img class="rleader" src="http://www.cafecowboys.com/wp-content/uploads/2016/04/blogging-inside.gif" />In case you haven’t already noticed, I’ve made some changes to my blog recently. Nothing really significant or drastic, but things that have been on the TODO list for a while.</p>

<p>I guess the most obvious change would be that I added pagination finally. If you scroll the homepage all the way down, instead of it going back through the entire blog’s history, it stops after five posts, and then gives a clickable page counter. Once I had this implemented, I then had to un-paginate the archive pages which was interesting.</p>

<p>The next most visible change would probably be the change I made to the CSS concerning CODE and CODEBLOCK. I’m still not 100% sure this is the final form, but I like it better than it was. For reference, it now looks like <code class="highlighter-rouge">this</code>.</p>

<p>My third change was to tweak the site’s header a bit. If you cast your gaze upwards, you can see that I now have ‘About’, ‘Archive’, and ‘Feeds’ in the header. The ‘Feeds’ link is new, as is the page that it links to. The actual RSS feeds themselves have existed for a while now, I just didn’t announce them.</p>

<p>And finally, I swapped out my photo for my new Bitmoji-based avatar.</p>

<p>So, uh, enjoy. Or something.</p>

    </DIV><!-- /.entry-content -->
  </ARTICLE><!-- /.hentry -->

  <ARTICLE class="hentry">
    <HEADER>
      
        <DIV class="entry-image-index">
          <A href="/posts/EXPLAINing-intermittent-perf-problems/" title="EXPLAINing intermittent perf problems"><IMG src="/images/db.jpg" alt="EXPLAINing intermittent perf problems" /></A>
        </DIV><!-- /.entry-image -->
      
      <DIV class="entry-meta">
        <SPAN class="entry-date date published updated">
          <TIME datetime="2016-11-28T07:24:12-05:00" />
            <A href="/posts/EXPLAINing-intermittent-perf-problems/">November 28, 2016</A>
          </TIME>
        </SPAN>
        <SPAN class="author vcard">
          <SPAN class="fn">
            <A href="/about/" title="About Douglas J Hunley">Douglas J Hunley</A>
          </SPAN>
        </SPAN>
        
          <SPAN class="entry-reading-time">
            <I class="fa fa-clock-o"></i>
            
Reading time ~5 minutes
          </SPAN><!-- /.entry-reading-time -->
        
      </DIV><!-- /.entry-meta -->
      
        <H1 class="entry-title">
          <A href="/posts/EXPLAINing-intermittent-perf-problems/" rel="bookmark" title="EXPLAINing intermittent perf problems" itemprop="url">EXPLAINing intermittent perf problems</A>
        </H1>
      
    </HEADER>
    <DIV class="entry-content">
      <p><img src="http://i0.kym-cdn.com/entries/icons/original/000/010/997/35s7cv.jpg" class="lleader" />We’ve all gotten the dreaded email/call from a user stating that a query is “slow sometimes”. If you’re lucky, the “sometimes” actually ends up being fairly consistent and you can fairly easily determine what’s happening (an errant cron job, for example). All too often though, the issue really is sporadic, fleeting, and indeterministic. So how do you track these down? And more importantly what do you do about them once found?</p>

<p>For starters, you as the DBA should have your PostgreSQL logging configured to log these slow performing queries. After all, you and the devs and the users can agree that all queries should complete in some measure of time (1 sec, 1 minute, etc). So, once you know what this acceptable elapsed time is, you can easily log any query that runs longer by just setting this in your <code class="highlighter-rouge">postgresql.conf</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>log_min_duration_statement = 1000   # log anything running longer than 1s
</code></pre>
</div>

<p>And now, you have all queries with long run times logged automatically. And these show up nicely in your pgBadger reports too!</p>

<p>If you’re lucky, you’ll be able to use <code class="highlighter-rouge">EXPLAIN</code> to see why the query is behaving poorly. However, if your life is like mine, the explain plan will be reasonable and won’t have any smoking guns to speak of. Which means the performance is either load dependent or being influenced by other processes (something is blowing out your caches, for example). In these cases, what you really need is the <code class="highlighter-rouge">EXPLAIN</code> output from the very instant that it performed poorly. However, you can’t go back in time to get it. But what you can do is make use of the <code class="highlighter-rouge">auto_explain</code> module that ships with PostgreSQL.</p>

<p>In case the name wasn’t obvious enough, the <code class="highlighter-rouge">auto_explain</code> module causes PostgreSQL to automatically run <code class="highlighter-rouge">EXPLAIN</code> on queries according to thresholds that you configure. These automatically generated plans are then logged into the normal PostgreSQL logs. Let’s walk through setting it up and see how it works.</p>

<p>First, in your <code class="highlighter-rouge">postgresql.conf</code> we want to enable the module:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>shared_preload_libraries = 'auto_explain'  # change requires restart
</code></pre>
</div>

<p>As stated, you will have to restart the postmaster to get the module to load. However, let’s configure it in <code class="highlighter-rouge">postgresql.conf</code> first:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Add settings for extensions here
#
# auto_explain
# http://www.postgresql.org/docs/current/static/auto-explain.html
auto_explain.log_analyze = true
auto_explain.log_timing = true
auto_explain.log_verbose = true
auto_explain.log_min_duration = '1000ms'
auto_explain.log_nested_statements = true
auto_explain.log_buffers = true
# auto_explain
</code></pre>
</div>

<p>What we’ve done here is configure <code class="highlighter-rouge">auto_explain</code> to</p>

<ul>
  <li>use <code class="highlighter-rouge">EXPLAIN ANALYZE</code><sup>1</sup></li>
  <li>to use the <code class="highlighter-rouge">TIMING</code> option of <code class="highlighter-rouge">EXPLAIN</code></li>
  <li>to use the <code class="highlighter-rouge">VERBOSE</code> option of <code class="highlighter-rouge">EXPLAIN</code></li>
  <li>to log the plan for anything running longer than 1 second (matches <code class="highlighter-rouge">log_min_duration_statement</code>, above)</li>
  <li>to include statements inside a function to also be logged</li>
  <li>to use the <code class="highlighter-rouge">BUFFERS</code> option of <code class="highlighter-rouge">EXPLAIN</code></li>
</ul>

<p>As with most <code class="highlighter-rouge">GUC</code> in PostgreSQL, these can all be changed using <code class="highlighter-rouge">SET</code> in a given session, but we’re setting the defaults here. Now that we have them setup, let’s see what it looks like in practice.</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">28838</span><span class="p">])</span> <span class="o">#</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span> <span class="n">text</span><span class="p">);</span>
<span class="k">CREATE</span> <span class="k">TABLE</span>
<span class="n">Time</span><span class="p">:</span> <span class="mi">6</span><span class="p">.</span><span class="mi">022</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">28838</span><span class="p">])</span> <span class="o">#</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">x</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">SELECT</span> <span class="n">generate_series</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10000</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="mi">0</span> <span class="mi">10000</span>
<span class="n">Time</span><span class="p">:</span> <span class="mi">23</span><span class="p">.</span><span class="mi">565</span> <span class="n">ms</span>
<span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">28838</span><span class="p">])</span> <span class="o">#</span>
</code></pre>
</div>

<p>We connected to PostgreSQL, created a test table, and then used <code class="highlighter-rouge">generate_series</code> to insert 10k rows. In our logs, the following were added:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>2016-11-28 13:20:30 EST [28838]: [18-1] user=doug,db=doug,app=psql,client=[local] LOG:  duration: 33.987 ms  statement: CREATE TABLE x(t text);
2016-11-28 13:20:59 EST [28838]: [19-1] user=doug,db=doug,app=psql,client=[local] LOG:  duration: 16.461 ms  plan:
  Query Text: INSERT INTO x(t) SELECT generate_series(1,10000);
  Insert on public.x  (cost=0.00..50.02 rows=1000 width=32) (actual time=16.459..16.459 rows=0 loops=1)
    Buffers: shared hit=10085 read=47 dirtied=45
    I/O Timings: read=0.012
    -&gt;  Subquery Scan on "*SELECT*"  (cost=0.00..50.02 rows=1000 width=32) (actual time=0.010..4.755 rows=10000 loops=1)
          Output: "*SELECT*".generate_series
          -&gt;  Result  (cost=0.00..15.02 rows=1000 width=4) (actual time=0.007..1.364 rows=10000 loops=1)
                Output: generate_series(1, 10000)
2016-11-28 13:20:59 EST [28838]: [20-1] user=doug,db=doug,app=psql,client=[local] LOG:  duration: 23.374 ms  statement: INSERT INTO x(t) SELECT generate_series(1,10000);
2016-11-28 13:21:00 EST [30079]: [1-1] user=,db=,app=,client= LOG:  automatic analyze of table "doug.public.x" system usage: CPU 0.00s/0.11u sec elapsed 0.14 sec
</code></pre>
</div>

<p>(Note that for illustrative purposes, I issued <code class="highlighter-rouge">SET auto_explain.log_min_duration = '0ms'</code>)</p>

<p>So, you can see that the <code class="highlighter-rouge">CREATE TABLE</code> didn’t log anything through the <code class="highlighter-rouge">auto_explain</code> module, but the <code class="highlighter-rouge">INSERT INTO</code> did. This is a boring example, so let’s try a <code class="highlighter-rouge">SELECT</code> against our table:</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="n">doug</span><span class="o">@</span><span class="p">[</span><span class="k">local</span><span class="p">]:</span><span class="mi">5432</span><span class="o">/</span><span class="n">doug</span><span class="p">[</span><span class="mi">28838</span><span class="p">])</span> <span class="o">#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">x</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">t</span> <span class="k">LIMIT</span> <span class="mi">10</span><span class="p">;</span>
<span class="err">┌───────┐</span>
<span class="err">│</span>   <span class="n">t</span>   <span class="err">│</span>
<span class="err">├───────┤</span>
<span class="err">│</span> <span class="mi">1</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mi">10</span>    <span class="err">│</span>
<span class="err">│</span> <span class="mi">100</span>   <span class="err">│</span>
<span class="err">│</span> <span class="mi">1000</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">10000</span> <span class="err">│</span>
<span class="err">│</span> <span class="mi">1001</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1002</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1003</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1004</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">1005</span>  <span class="err">│</span>
<span class="err">└───────┘</span>
<span class="p">(</span><span class="mi">10</span> <span class="k">rows</span><span class="p">)</span>

<span class="n">Time</span><span class="p">:</span> <span class="mi">11</span><span class="p">.</span><span class="mi">982</span> <span class="n">ms</span>
</code></pre>
</div>

<p>and the logs look like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>2016-11-28 13:27:38 EST [322]: [7-1] user=,db=,app=,client= LOG:  checkpoint starting: time
2016-11-28 13:27:46 EST [322]: [8-1] user=,db=,app=,client= LOG:  checkpoint complete: wrote 75 buffers (0.0%); 0 transaction log file(s) added, 0 removed, 0 recycled; write=7.569 s, sync=0.092 s, total=7.920 s; sync files=23, longest=0.092 s, average=0.004 s; distance=685 kB, estimate=685 kB
2016-11-28 13:28:48 EST [28838]: [21-1] user=doug,db=doug,app=psql,client=[local] LOG:  duration: 11.120 ms  plan:
  Query Text: SELECT * FROM x ORDER BY t LIMIT 10;
  Limit  (cost=561.10..561.12 rows=10 width=4) (actual time=11.073..11.073 rows=10 loops=1)
    Output: t
    Buffers: shared hit=45
    -&gt;  Sort  (cost=561.10..586.10 rows=10000 width=4) (actual time=11.072..11.072 rows=10 loops=1)
          Output: t
          Sort Key: x.t
          Sort Method: top-N heapsort  Memory: 25kB
          Buffers: shared hit=45
          -&gt;  Seq Scan on public.x  (cost=0.00..345.00 rows=10000 width=4) (actual time=0.018..1.224 rows=10000 loops=1)
                Output: t
                Buffers: shared hit=45
2016-11-28 13:28:48 EST [28838]: [22-1] user=doug,db=doug,app=psql,client=[local] LOG:  duration: 11.813 ms  statement: SELECT * FROM x ORDER BY t LIMIT 10;
</code></pre>
</div>

<p>(You can safely ignore the checkpoint lines at the top there)</p>

<p>There you have both the statement we ran, and the full <code class="highlighter-rouge">EXPLAIN</code> plan. You can see we did a sequential scan on the table (looks like it was all in the <code class="highlighter-rouge">shared_buffers</code> too) and then we passed that up to a <code class="highlighter-rouge">sort</code> node for an in-memory sort, and then passed that result set up to the <code class="highlighter-rouge">limit</code> node.</p>

<p>While this is a stupid simple example, I hope you can see that having this in production for large, complicated queries will allow you to better diagnose issues. For example, simply doing a manual <code class="highlighter-rouge">EXPLAIN ANALYZE</code> on the same query and seeing that you get a different plan is potentially enough to rule out (or in) certain culprits for the intermittent performance issue.
<br />
<br />
<br />
<br />
<sup>1</sup> - This option causes the postmaster to collect info on <em>every</em> statement executed, even if <code class="highlighter-rouge">auto_explain</code> isn’t going to log it. It has a measurable impact on overall performance. Please test on your workload and decide for yourself if the overhead is worth the trade-off</p>

    </DIV><!-- /.entry-content -->
  </ARTICLE><!-- /.hentry -->

  <ARTICLE class="hentry">
    <HEADER>
      
        <DIV class="entry-image-index">
          <A href="/posts/PostgreSQL-logging-strftime-and-you/" title="PostgreSQL logging, strftime, and you"><IMG src="/images/db.jpg" alt="PostgreSQL logging, strftime, and you" /></A>
        </DIV><!-- /.entry-image -->
      
      <DIV class="entry-meta">
        <SPAN class="entry-date date published updated">
          <TIME datetime="2016-11-21T07:17:03-05:00" />
            <A href="/posts/PostgreSQL-logging-strftime-and-you/">November 21, 2016</A>
          </TIME>
        </SPAN>
        <SPAN class="author vcard">
          <SPAN class="fn">
            <A href="/about/" title="About Douglas J Hunley">Douglas J Hunley</A>
          </SPAN>
        </SPAN>
        
          <SPAN class="entry-reading-time">
            <I class="fa fa-clock-o"></i>
            
Reading time ~5 minutes
          </SPAN><!-- /.entry-reading-time -->
        
      </DIV><!-- /.entry-meta -->
      
        <H1 class="entry-title">
          <A href="/posts/PostgreSQL-logging-strftime-and-you/" rel="bookmark" title="PostgreSQL logging, strftime, and you" itemprop="url">PostgreSQL logging, strftime, and you</A>
        </H1>
      
    </HEADER>
    <DIV class="entry-content">
      <p><img src="http://www.metasource.com/images/content/data-processing-image.jpg" class="rleader" />PostgreSQL has a pretty extensive logging facility. I’ve talked briefly about configuring it to get the most out of pgBadger before, but today I’m gonna talk a bit about the naming of the log file itself. The chosen filename doesn’t have to be static. You can, in fact, have the name dynamically created by using strftime() escapes. But what exactly are those?</p>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>    The strftime() function formats the information from timeptr into the buffer s,
    according to the string pointed to by format.

    The format string consists of zero or more conversion specifications and ordi-
    nary characters.  All ordinary characters are copied directly into the buffer.
    A conversion specification consists of a percent sign ```%''' and one other
    character.
</code></pre>
</div>

<p>Say what? Essentially, given a timestamp and a format specification, you’ll get the timestamp back in a different formatted output. So what are these format specifications? Well, they are defined by your systems <code class="highlighter-rouge">libc</code> implementation. On Linux, this is (typically) glibc, whereas on OSX and the BSDs, it’s BSD libc. You really shouldn’t see a difference between these two, but it could happen. On macOS Sierra, they are (for the examples below, we’ll use today’s date of Monday, November 21, 2016 with a timestamp of 1pm EST):</p>

<div class="language-apache highlighter-rouge"><pre class="highlight"><code>    <span class="err">%</span>A    is replaced by national representation of the <span class="ss">full</span> weekday name ("Monday")
    <span class="err">%</span>a    is replaced by national representation of the abbreviated weekday name ("Mon")
    <span class="err">%</span>B    is replaced by national representation of the <span class="ss">full</span> month name ("November")
    <span class="err">%</span>b    is replaced by national representation of the abbreviated month name ("Nov")
    <span class="err">%</span>C    is replaced by (year / 100) as decimal number; single digits are preceded by a zero ("20")
    <span class="err">%</span>c    is replaced by national representation of time and date ("Mon Nov 21 13:00:00 2016")
    <span class="err">%</span>D    is equivalent to ``%m/%d/%y'' ("11/21/16")
    <span class="err">%</span>d    is replaced by the day of the month as a decimal number (01-31) ("21")
    <span class="err">%</span>e    is replaced by the day of the month as a decimal number (1-31); single digits are preceded by a blank ("21")
    <span class="err">%</span>F    is equivalent to ``%Y-%m-%d'' ("2016-11-21")
    <span class="err">%</span>G    is replaced by a year as a decimal number with century.  This year is the one that contains the greater part of the week (Monday as the first day of the week) ("2016")
    <span class="err">%</span>g    is replaced by the same year as in ``%G'', but as a decimal number without century (00-99) ("16")
    <span class="err">%</span>H    is replaced by the hour (24-hour clock) as a decimal number (00-23) ("12")
    <span class="err">%</span>h    the same as %b ("Nov")
    <span class="err">%</span>I    is replaced by the hour (12-hour clock) as a decimal number (01-12) ("12")
    <span class="err">%</span>j    is replaced by the day of the year as a decimal number (001-366) ("326")
    <span class="err">%</span>k    is replaced by the hour (24-hour clock) as a decimal number (0-23); single digits are preceded by a blank ("13")
    <span class="err">%</span>l    is replaced by the hour (12-hour clock) as a decimal number (1-12); single digits are preceded by a blank (" 1")
    <span class="err">%</span>M    is replaced by the minute as a decimal number (00-59) ("00")
    <span class="err">%</span>m    is replaced by the month as a decimal number (01-12) ("11")
    <span class="err">%</span>n    is replaced by a newline
    <span class="err">%</span>p    is replaced by national representation of either "ante meridiem" (a.m.) or "post meridiem" (p.m.)  as appropriate ("PM")
    <span class="err">%</span>R    is equivalent to ``%H:%M'' ("13:00")
    <span class="err">%</span>r    is equivalent to ``%I:%M:%S %p'' ("01:00:00 PM")
    <span class="err">%</span>S    is replaced by the second as a decimal number (00-60) ("00")
    <span class="err">%</span>s    is replaced by the number of seconds since the Epoch, UTC ("1479751200")
    <span class="err">%</span>T    is equivalent to ``%H:%M:%S'' ("13:00:00")
    <span class="err">%</span>t    is replaced by a tab
    <span class="err">%</span>U    is replaced by the week number of the year (Sunday as the first day of the week) as a decimal number (00-53) ("47")
    <span class="err">%</span>u    is replaced by the weekday (Monday as the first day of the week) as a decimal number (1-7) ("1")
    <span class="err">%</span>V    is replaced by the week number of the year (Monday as the first day of the week) as a decimal number (01-53).  If the week containing January 1 has four or more days in the new year, then it is week 1; otherwise it is the last week of the previous year, and the next week is week 1 ("47")
    <span class="err">%</span>v    is equivalent to ``%e-%b-%Y'' ("21-Nov-2016")
    <span class="err">%</span>W    is replaced by the week number of the year (Monday as the first day of the week) as a decimal number (00-53) ("47")
    <span class="err">%</span>w    is replaced by the weekday (Sunday as the first day of the week) as a decimal number (0-6) ("1")
    <span class="err">%</span>X    is replaced by national representation of the time ("13:00:00")
    <span class="err">%</span>x    is replaced by national representation of the date ("11/21/2016")
    <span class="err">%</span>Y    is replaced by the year with century as a decimal number ("2016")
    <span class="err">%</span>y    is replaced by the year without century as a decimal number (00-99) ("16")
    <span class="err">%</span>Z    is replaced by the time zone name ("EST")
    <span class="err">%</span>z    is replaced by the time zone offset <span class="ss">from</span> UTC; a leading plus sign stands for east of UTC, a minus sign for west of UTC, hours and minutes follow with two digits each and no delimiter between them ("-0500")
    <span class="err">%%</span>    is replaced by `%'
</code></pre>
</div>

<p>Phew! That was a lot wasn’t it? And where exactly does this come into play? As the <code class="highlighter-rouge">postgresql.conf</code> says:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>log_filename = 'postgresql-%a.log'      # log file name pattern,
                                        # can include strftime() escapes
</code></pre>
</div>

<p>So, you can use any of the escapes above to craft a filename that automagically gets updated according to the current timestamp. In my example above, I’m getting PostgreSQL to create a new logfile with the local weekday abbreviation. So my <code class="highlighter-rouge">$PGDATA/pg_log</code> directory will only ever contain:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>postgresql-Sun.log postgresql-Mon.log postgresql-Tue.log
postgresql-Wed.log postgresql-Thu.log postgresql-Fri.log
postgresql-Sat.log
</code></pre>
</div>

<p>But wait! The key to all this is that <em>PostgreSQL only evaluates the filename when it first opens/creates the logfile</em>. So, if you start your cluster on Mon and do not restart it and don’t have it configured to log rotate, you’ll still be writing to <code class="highlighter-rouge">postgresql-Mon.log</code> forever. Fortunately, PostgreSQL has you covered here too:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>log_rotation_age = 1d      # Automatic rotation of logfiles will
                           # happen after that time.  0 disables.
log_rotation_size = 10MB   # Automatic rotation of logfiles will
                           # happen after that much log output.
                           # 0 disables.
</code></pre>
</div>

<p>So, using my <code class="highlighter-rouge">log_filename</code> from above, I enable <code class="highlighter-rouge">log_rotation_age</code> (set to 1 day) and disable <code class="highlighter-rouge">log_rotation_size</code> and I automatically get a new log every day. If I wanted hourly logs, I could do something like:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>log_filename = 'postgresql-%a-%H'
log_rotation_age = 1h
</code></pre>
</div>

<p>which would give me logs of <code class="highlighter-rouge">postgresql-Mon-00</code>, <code class="highlighter-rouge">postgresql-Mon-01</code>, etc. You should be able to see how combining these three <code class="highlighter-rouge">postgresql.conf</code> parameters and some crafty strftime() escapes gives you a <em>ton</em> of flexibility in your logging. So go forth and tweak those logs!</p>

    </DIV><!-- /.entry-content -->
  </ARTICLE><!-- /.hentry -->

  <ARTICLE class="hentry">
    <HEADER>
      
        <DIV class="entry-image-index">
          <A href="/posts/Upgrading-PostgreSQL-5x-faster/" title="Upgrading PostgreSQL 5x faster"><IMG src="/images/db.jpg" alt="Upgrading PostgreSQL 5x faster" /></A>
        </DIV><!-- /.entry-image -->
      
      <DIV class="entry-meta">
        <SPAN class="entry-date date published updated">
          <TIME datetime="2016-11-18T07:18:28-05:00" />
            <A href="/posts/Upgrading-PostgreSQL-5x-faster/">November 18, 2016</A>
          </TIME>
        </SPAN>
        <SPAN class="author vcard">
          <SPAN class="fn">
            <A href="/about/" title="About Douglas J Hunley">Douglas J Hunley</A>
          </SPAN>
        </SPAN>
        
          <SPAN class="entry-reading-time">
            <I class="fa fa-clock-o"></i>
            
Reading time ~3 minutes
          </SPAN><!-- /.entry-reading-time -->
        
      </DIV><!-- /.entry-meta -->
      
        <H1 class="entry-title">
          <A href="/posts/Upgrading-PostgreSQL-5x-faster/" rel="bookmark" title="Upgrading PostgreSQL 5x faster" itemprop="url">Upgrading PostgreSQL 5x faster</A>
        </H1>
      
    </HEADER>
    <DIV class="entry-content">
      <p><img src="http://www.navops.io/img/launch-samsung-1.gif" class="lleader" />Upgrading your PostgreSQL database from one major version (e.g. 9.4.x) to another major version (e.g. 9.5.x) used to a painful and exceedingly slow process. You essentially had two options: dump / reload the data or use one of the complex logical replication tools.</p>

<p>Thankfully, the PostgreSQL team introduced <code class="highlighter-rouge">pg_upgrade</code> back in version 9.0. Because the way data is stored internally in its datafiles in PostgreSQL rarely changes, <code class="highlighter-rouge">pg_upgrade</code> is able to re-use the existing datafiles (while manipulating some catalog entries) to “short circuit” the upgrade process. While this isn’t (yet) a true “in place upgrade” as done by some other databases, it’s pretty close. And it’s stupid fast. In my testing on my overworked Macbook Pro, it took <em>1/5</em> as long to upgrade as a traditional dump and reload. So, let’s look at this process shall we?</p>

<p>First, we assume that we have both PostgreSQL 9.5 and 9.6 installed and both have initialized (empty) clusters (see <a href="https://hunleyd.github.io/Getting-fancy-with-PostgreSQL-and-Homebrew/">here</a> if you need to do this). We’re going to use <code class="highlighter-rouge">pgbench</code> to create some data in our PostgreSQL 9.5 instance:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>doug@Douglass-MacBook-Pro ~/foo » pg 9.5
doug@Douglass-MacBook-Pro ~/foo » createdb bench1; createdb bench2; createdb bench3
doug@Douglass-MacBook-Pro ~/foo » pgbench -i -s 15 bench1 ; pgbench -i -s 70 bench2 ; pgbench -i -s 600 bench3
doug@Douglass-MacBook-Pro ~/foo » pgbench -c 4 -j 2 -T 600 bench1 ; pgbench -c 4 -j 2 -T 600 bench2 ; pgbench -c 4 -j 2 -T 600 bench3
</code></pre>
</div>

<p>Now that we’ve got data in our cluster, we can do the dump. If this were a production instance, <em>this is where you’d have to stop your application(s)</em>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>doug@Douglass-MacBook-Pro ~/foo » time pg_dumpall &gt; data.sql
pg_dumpall &gt; data.sql  20.57s user 30.63s system 4% cpu 18:43.70 total
</code></pre>
</div>

<p>We’ve now dumped out all our data, and spent 18 minutes with the application(s) down. Let’s restore our data to the PostgreSQL 9.6 cluster now:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>doug@Douglass-MacBook-Pro ~/foo » pg 9.6
doug@Douglass-MacBook-Pro ~/foo » time psql -f data.sql
psql -f data.sql  14.53s user 18.30s system 1% cpu 37:48.49 total
</code></pre>
</div>

<p>After 37 minutes, our data is back and we can start our applications back up. <em>An outage of approximately 56.5 minutes</em>.</p>

<p>Now, let’s blow away our PostgreSQL 9.6 cluster and use <code class="highlighter-rouge">pg_upgrade</code> to complete the same task. You would do this with the application(s) down as well!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>doug@Douglass-MacBook-Pro ~/foo » rm -fr $PGDATA/*
doug@Douglass-MacBook-Pro ~/foo » initdb $PGDATA
doug@Douglass-MacBook-Pro ~/foo » export OPGDATA=$PGDATA/../9.5
doug@Douglass-MacBook-Pro ~/foo » time pg_upgrade -d $OPGDATA -D $PGDATA -b /usr/local/opt/postgresql-9.5/bin -B /usr/local/opt/postgresql-9.6/bin
pg_upgrade -d $OPGDATA -D $PGDATA -b /usr/local/opt/postgresql-9.5/bin -B   0.40s user 12.12s system 1% cpu 10:26.64 total
</code></pre>
</div>

<p>And we’re done <em>in 10.5 minutes</em>. It took 1/5 the outage of the dump / load method. And that’s on my puny dataset with my overworked laptop! Pretty impressive, no?</p>

<p>For the curious, the <code class="highlighter-rouge">pg_upgrade</code> output that I omitted above for readability’s sake is:</p>

<noscript><pre>```
Performing Consistency Checks
-----------------------------
Checking cluster versions                                   ok
Checking database user is the install user                  ok
Checking database connection settings                       ok
Checking for prepared transactions                          ok
Checking for reg* system OID user data types                ok
Checking for contrib/isn with bigint-passing mismatch       ok
Checking for roles starting with &#39;pg_&#39;                      ok
Creating dump of global objects                             ok
Creating dump of database schemas
                                                            ok
Checking for presence of required libraries                 ok
Checking database user is the install user                  ok
Checking for prepared transactions                          ok

If pg_upgrade fails after this point, you must re-initdb the
new cluster before continuing.

Performing Upgrade
------------------
Analyzing all rows in the new cluster                       ok
Freezing all rows on the new cluster                        ok
Deleting files from new pg_clog                             ok
Copying old pg_clog to new server                           ok
Setting next transaction ID and epoch for new cluster       ok
Deleting files from new pg_multixact/offsets                ok
Copying old pg_multixact/offsets to new server              ok
Deleting files from new pg_multixact/members                ok
Copying old pg_multixact/members to new server              ok
Setting next multixact ID and offset for new cluster        ok
Resetting WAL archives                                      ok
Setting frozenxid and minmxid counters in new cluster       ok
Restoring global objects in the new cluster                 ok
Restoring database schemas in the new cluster
                                                            ok
Copying user relation files                                 ok
Setting next OID for new cluster                            ok
Sync data directory to disk                                 ok
Creating script to analyze new cluster                      ok
Creating script to delete old cluster                       ok

Upgrade Complete
----------------
Optimizer statistics are not transferred by pg_upgrade so,
once you start the new server, consider running:
    ./analyze_new_cluster.sh

Running this script will delete the old cluster&#39;s data files:
    ./delete_old_cluster.sh
```</pre></noscript>
<script src="https://gist.github.com/hunleyd/3ff1f5503fc42e3446b35715bd0ec932.js"> </script>


    </DIV><!-- /.entry-content -->
  </ARTICLE><!-- /.hentry -->



<div class="pagination">
  <ul class="inline-list">
    
    

    
    
      <li><strong class="current-page">1</strong></li>
    

    
    

    
    
    

    
      
        
        
        
        <li><a href="/pages/2/">2</a></li>
      
    
      
        
        
        
        <li><a href="/pages/3/">3</a></li>
      
    

    
    
      <li>…</li>
    

    
      <li><a href="/pages/7/">7</a></li>
    

    
    
      <li><a href="/pages/2/" class="btn">Next</a></li>
    
  </ul>
</div>



</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Douglas J Hunley.<BR /><FONT size=-1>Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a>. Served via <a href="https://github.com">GitHub</a>. Themed using <a href="https://mademistakes.com/work/hpstr-jekyll-theme/" rel="nofollow">HPSTR</a>.</FONT></span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>



          

</body>
</html>