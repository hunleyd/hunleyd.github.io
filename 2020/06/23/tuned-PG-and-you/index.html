<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      tuned, PG, and you &middot; Doug's Dabblings
    
  </title>

  
  <link rel="canonical" href="/2020/06/23/tuned-PG-and-you/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">tuned, PG, and you</h1>
  <span class="post-date">
    23 Jun 2020,
    This article will take 2 minutes to read.<br />
    postgresql &bullet; linux <br />
  </span>

  <p>We’ve had a small flurry of customers asking about tuning their OS for the best PostgreSQL performance. While the answer to this question is always ‘that depends on your hardware and workload’ and involves a lot of iteration between changing a setting and benchmarking, I thought I’d take a moment to point out that once you do manage to dial-in the settings, you should be writing a profile and deploying to your systems for <code class="language-plaintext highlighter-rouge">tuned</code> to make use of. Please, for the love of $diety, stop editing <code class="language-plaintext highlighter-rouge">sysctl.conf</code> and friends!</p>

<p>If you’re running RedHat (or a RedHat-derived) OS, <code class="language-plaintext highlighter-rouge">tuned</code> is probably already installed and may even be already running. If not, it’s a simple <code class="language-plaintext highlighter-rouge">yum install tuned</code> to rectify. If you’re on Debian (or a Debian-derived) OS, simply <code class="language-plaintext highlighter-rouge">apt install tuned</code>. Now that you have it installed, you can ask it to recommend a profile for you by issuing <code class="language-plaintext highlighter-rouge">tuned-adm recommend</code> and you can see which profile, if any, is in use by issuing <code class="language-plaintext highlighter-rouge">tuned-adm active</code>. You can also list all the available profiles with <code class="language-plaintext highlighter-rouge">tuned-adm list</code>.</p>

<p>That’s great and all, but there’s no PostgreSQL profile that ships with <code class="language-plaintext highlighter-rouge">tuned</code>. So, let’s build one! First, decide which of the profiles in <code class="language-plaintext highlighter-rouge">tuned-adm list</code> is the most appropriate starting point for you. If you’re running on bare metal, this is probably <code class="language-plaintext highlighter-rouge">throughput-performance</code>. If your system is virtualized, you probably want <code class="language-plaintext highlighter-rouge">virtual-guest</code>. We’re going to use this profile as the ‘base’ of our profile. Profiles are stored in <code class="language-plaintext highlighter-rouge">/etc/tuned</code>, so let’s start setting ours up:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mkdir</span> /etc/tuned/postgresql
<span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/tuned/postgresql/tuned.conf
[main]
include= throughput-performance
</span><span class="no">
EOF
</span></code></pre></div></div>

<p>As you can see, we’re going to start with the <code class="language-plaintext highlighter-rouge">throughput-performance</code> profile as a base, and then make tweaks from there. The first tweak? Disable Transparent Huge Pages (THP):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/tuned/postgresql/tuned.conf
[vm]
transparent_hugepages=never
</span><span class="no">EOF
</span></code></pre></div></div>

<p>If you’re not aware, THP on a dedicated PostgreSQL server really don’t play nicely. It’s best to avoid them completely.</p>

<p>Now, we want to set the ‘standard database VM config’ so we:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/tuned/postgresql/tuned.conf

[sysctl]
vm.overcommit_memory = 2
vm.swappiness = 1
</span><span class="no">EOF
</span></code></pre></div></div>

<p>As pointed out in the comments, <code class="language-plaintext highlighter-rouge">vm.overcommit_memory</code> and <code class="language-plaintext highlighter-rouge">vm.dirty_ratio</code> (which I set below) interplay. <code class="language-plaintext highlighter-rouge">vm.dirty_ratio</code> is the value that represents the percentage of MemTotal that can consume dirty pages before all processes must write dirty buffers back to disk and when this value is reached all I/O is blocked for any new writes until dirty pages have been flushed. By default this set to 50% which means that at most only <strong>half</strong> of your MemTotal can ever only be dirty at once. Please see <a href="https://www.kernel.org/doc/Documentation/vm/overcommit-accounting">the kernel documentation</a> for details on all these settings.</p>

<p>I, personally, also then add (after benchmarking, of course):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; /etc/tuned/postgresql/tuned.conf
kernel.sched_autogroup_enabled = 0
kernel.sched_migration_cost_ns = 50000000
vm.dirty_background_bytes = 134217728
vm.dirty_expire_centisecs = 499
vm.dirty_ratio = 90
vm.overcommit_ratio = 90
vm.zone_reclaim_mode = 0
</span><span class="no">EOF
</span></code></pre></div></div>

<p>This gives you a complete PostgreSQL tuned profile that looks like:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">main</span>]
<span class="n">include</span>= <span class="n">throughput</span>-<span class="n">performance</span>

[<span class="n">sysctl</span>]
<span class="n">kernel</span>.<span class="n">sched_autogroup_enabled</span> = <span class="m">0</span>
<span class="n">kernel</span>.<span class="n">sched_migration_cost_ns</span> = <span class="m">50000000</span>
<span class="n">vm</span>.<span class="n">dirty_background_bytes</span> = <span class="m">134217728</span>
<span class="n">vm</span>.<span class="n">dirty_expire_centisecs</span> = <span class="m">499</span>
<span class="n">vm</span>.<span class="n">dirty_ratio</span> = <span class="m">90</span>
<span class="n">vm</span>.<span class="n">overcommit_memory</span> = <span class="m">2</span>
<span class="n">vm</span>.<span class="n">overcommit_ratio</span> = <span class="m">90</span>
<span class="n">vm</span>.<span class="n">swappiness</span> = <span class="m">1</span>
<span class="n">vm</span>.<span class="n">zone_reclaim_mode</span> = <span class="m">0</span>

[<span class="n">vm</span>]
<span class="n">transparent_hugepages</span>=<span class="n">never</span>
</code></pre></div></div>

<p>(well, in a slightly different order, but you get the drift).</p>

<p>Now that we have our profile, run a quick <code class="language-plaintext highlighter-rouge">tuned-adm list</code> to ensure that it is listed as available. Assuming it is, you can enable it with <code class="language-plaintext highlighter-rouge">tune-adm profile postgresql</code> and then double-check that it took effect with <code class="language-plaintext highlighter-rouge">tune-adm active</code>.</p>

<p>Once activated, you should be all set. Happy computing, or something. ;)</p>


  
  <div>
    <h3>Related Posts</h3>
    <ul>
    
      <li><a href="/2021/08/14/Generating-DNS-noise/">Generating DNS noise</a></li>
    
      <li><a href="/2021/07/31/Ricing-it-up/">Ricing it up</a></li>
    
      <li><a href="/2021/07/24/Hello-again-old-friend/">Hello again old friend</a></li>
    
      <li><a href="/2020/07/30/It-s-Podman-man/">It's Podman, man</a></li>
    
      <li><a href="/2020/07/19/Bye-Pi-Hello-NUC/">Bye Pi, Hello NUC</a></li>
    
    </ul>
  </div>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
