<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Doug's Dabblings &middot; Quick thoughts on stuff I'm playing with
    
  </title>

  
  <link rel="canonical" href="/page19/">
  

  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/89f4c31870.js" crossorigin="anonymous"></script>
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A collection of thoughts on things in my life that I'm experiencing, playing with, or suffering through. Mostly tech related, but sometimes not.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item " href="/posts/">All Posts</a>
    <a class="sidebar-nav-item " href="/tags/">All Tags</a>
  </nav>

  <div class="sidebar-item">
      <a href="https://www.deviantart.com/dhunley"><i class="fab fa-deviantart"></i></a>
    <a href="mailto:%64%6F%75%67.%68%75%6E%6C%65%79@%67%6D%61%69%6C.%63%6F%6D"><i class="fas fa-envelope"></i></a>
      <a href="https://github.com/hunleyd"><i class="fab fa-github"></i></a>
      <a href="https://instagram.com/doughunley"><i class="fab fa-instagram-square"></i></a>
      <a href="https://last.fm/user/hunleyd"><i class="fab fa-lastfm-square"></i></a>
      <a href="https://www.linkedin.com/in/dhunley"><i class="fab fa-linkedin"></i></a>
      <a href="https://www.meetup.com/members/43608152/"><i class="fab fa-meetup"></i></a>
      <a href="https://reddit.com/u/hunleyd"><i class="fab fa-reddit-square"></i></a>
      <a href="https://https://open.spotify.com/user/z0emrjhe6h1bieo81fkrmdbqq"><i class="fab fa-spotify"></i></a>
      <a href="https://twitter.com/hunleyd"><i class="fab fa-twitter-square"></i></a>
      <a href="https://youtube.com/c/DouglasHunley"><i class="fab fa-youtube"></i></a>
    <p></p>
    <p>
      <a href="/atom.xml"><i class="fas fa-rss-square"></i></a>
    </p>
    <p></p>
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Doug's Dabblings</a>
            <small>Quick thoughts on stuff I'm playing with</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/10/16/updated-PostgreSQL-homebrew-script/">
        updated PostgreSQL homebrew script
      </a>
    </h1>

    <span class="post-date">16 Oct 2017</span>

    <p>With the release of PostgreSQL 10, I’ve updated my <code class="language-plaintext highlighter-rouge">pg</code> script. You might recall from previous posts that this script is for Homebrew users that have tapped Peter’s brew recipes. It allows for installing and switching between multiple version of PostgreSQL seemlessly. While I was in there adding v10 support, I tweaked and tuned the code a bit and tidyied up the output significantly. I’m pretty pleased with the new version actually.</p>

<p>As always, it’s been added as a gist:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/zsh</span>

<span class="nv">wanted_ver</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">no_restart</span><span class="o">=</span>

<span class="c"># is the version requested installed?</span>
brew <span class="nb">ls</span> <span class="nt">--version</span> postgresql@<span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span> &amp;&gt;/dev/null
<span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> <span class="nt">-eq</span> 0 <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="c"># yes, carry on</span>
  :
<span class="k">else</span>
  <span class="c"># nope, so install it</span>
  <span class="nb">echo</span> <span class="s2">"Installing PostgreSQL </span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2">... "</span>
  brew <span class="nb">install </span>petere/postgresql/postgresql@<span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c"># is postgresql is running?</span>
<span class="k">for </span>i <span class="k">in</span> /usr/local/var/postgres/<span class="k">*</span>
<span class="k">do
  </span><span class="nv">check_ver</span><span class="o">=</span><span class="si">$(</span><span class="nb">basename</span> <span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="si">)</span>
  <span class="nv">is_running</span><span class="o">=</span><span class="si">$(</span>ps <span class="nt">-few</span>|egrep <span class="nt">--</span> <span class="s2">"[p]ostgres.*-D.*</span><span class="k">${</span><span class="nv">check_ver</span><span class="k">}</span><span class="s2">"</span><span class="si">)</span>

  <span class="k">if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="k">${</span><span class="nv">is_running</span><span class="k">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c"># nope, carry on</span>
    :
  <span class="k">else</span>
    <span class="c"># it is. is it the requested version?</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">check_ver</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
      <span class="c"># yup, carry on</span>
      <span class="nv">no_restart</span><span class="o">=</span>t
    <span class="k">else</span>
      <span class="c"># nope, so kill it</span>
      <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Stopping PostgreSQL </span><span class="k">${</span><span class="nv">check_ver</span><span class="k">}</span><span class="s2">... "</span>
      /usr/local/opt/postgresql@<span class="k">${</span><span class="nv">check_ver</span><span class="k">}</span>/bin/pg_ctl <span class="se">\</span>
          <span class="nt">-D</span> /usr/local/var/postgres/<span class="k">${</span><span class="nv">check_ver</span><span class="k">}</span> <span class="se">\</span>
          stop <span class="nt">-w</span> <span class="nt">-mf</span> | <span class="nb">grep</span> <span class="s1">'stopped'</span>
    <span class="k">fi
  fi
done</span>

<span class="c"># what version is active?</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nt">-e</span> /usr/local/bin/psql <span class="o">]]</span> <span class="p">;</span> <span class="k">then
    </span><span class="nv">active_ver</span><span class="o">=</span><span class="si">$(</span>/usr/bin/stat <span class="nt">-f</span> %Y /usr/local/bin/psql | <span class="nb">cut</span> <span class="nt">-d</span><span class="se">\/</span> <span class="nt">-f3</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="se">\-</span> <span class="nt">-f2</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="se">\@</span> <span class="nt">-f2</span><span class="si">)</span>
<span class="k">else
    </span><span class="nv">active_ver</span><span class="o">=</span>0
<span class="k">fi</span>

<span class="c"># is the active version the requested version?</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">active_ver</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2">"</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="c"># yup, carry on</span>
  :
<span class="k">else</span>
  <span class="c"># nope, so deactivate it</span>
  <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Deactivating PostgreSQL </span><span class="k">${</span><span class="nv">active_ver</span><span class="k">}</span><span class="s2">... "</span>
  brew <span class="nb">unlink</span> <span class="nt">--force</span> <span class="nt">--overwrite</span> postgresql@<span class="k">${</span><span class="nv">active_ver</span><span class="k">}</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="se">\ </span> <span class="nt">-f3-</span>
  <span class="c"># and activate the correct version</span>
  <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Activating PostgreSQL </span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2">... "</span>
  brew <span class="nb">link</span> <span class="nt">--force</span> <span class="nt">--overwrite</span> postgresql@<span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span> | <span class="nb">grep</span> <span class="s1">'created'</span> | <span class="nb">cut</span> <span class="nt">-d</span><span class="se">\ </span> <span class="nt">-f3-</span>
<span class="k">fi</span>

<span class="c"># point to the correct data dir and port</span>
<span class="nv">PGDATA</span><span class="o">=</span>/usr/local/var/postgres/<span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span>
<span class="nv">PGPORT</span><span class="o">=</span><span class="s2">"54</span><span class="si">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span> | <span class="nb">tr</span> <span class="nt">-d</span> .<span class="si">)</span><span class="s2">"</span>

<span class="c"># should we be starting a cluster?</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="k">${</span><span class="nv">no_restart</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"t"</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
  <span class="c"># nope, carry on</span>
  :
<span class="k">else</span>
  <span class="c"># yup. has the cluster been initialized?</span>
  <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
    <span class="c"># nope, so let's do that</span>
    <span class="nb">echo</span> <span class="s2">"Initializing PostgreSQL </span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2"> cluster... "</span>
    initdb <span class="nt">-k</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span> <span class="o">||</span> initdb <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"port = </span><span class="k">${</span><span class="nv">PGPORT</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_destination = 'stderr'"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"logging_collector = on"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_filename = 'postgresql-%a.log'"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_truncate_on_rotation = on"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_rotation_age = 1d"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_rotation_size = 0"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_timezone = 'US/Michigan'"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
    <span class="nb">echo</span> <span class="s2">"log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '"</span> <span class="o">&gt;&gt;</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span>/postgresql.conf
  <span class="k">else</span>
    <span class="c"># yup, carry on</span>
    :
  <span class="k">fi</span>
  <span class="c"># start the cluster</span>
  <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Starting PostgreSQL </span><span class="k">${</span><span class="nv">wanted_ver</span><span class="k">}</span><span class="s2">... "</span>
  pg_ctl <span class="nt">-D</span> <span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span> start  <span class="o">&gt;</span> /tmp/pg.start 2&gt;&amp;1
  <span class="nb">grep</span> <span class="s1">'server start'</span> /tmp/pg.start
  <span class="k">if</span> <span class="o">[[</span> <span class="nt">-x</span> /usr/local/bin/pg_isready <span class="o">]]</span> <span class="p">;</span> <span class="k">then
      </span><span class="nv">ret</span><span class="o">=</span>1
      <span class="k">while</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">ret</span><span class="k">}</span> <span class="nt">-eq</span> 1 <span class="o">]]</span>
      <span class="k">do</span>
        <span class="c"># wait for the cluster to be available before exiting</span>
        pg_isready <span class="nt">-q</span>
        <span class="nv">ret</span><span class="o">=</span><span class="nv">$?</span>
      <span class="k">done
    fi
fi

</span><span class="nb">echo</span> <span class="s2">"export PGDATA=</span><span class="k">${</span><span class="nv">PGDATA</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"export PGPORT=</span><span class="k">${</span><span class="nv">PGPORT</span><span class="k">}</span><span class="s2">"</span>
</code></pre></div></div>

<p>Enjoy.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page20">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page18">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
